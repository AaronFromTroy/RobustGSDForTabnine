---
phase: 02-core-infrastructure
plan: 04
type: execute
wave: 3
depends_on:
  - 02-02
files_modified:
  - gsd/scripts/template-renderer.js
  - gsd/scripts/guideline-loader.js
autonomous: true

must_haves:
  truths:
    - "System can load a single guideline file by workflow name"
    - "System can render templates with variable substitution"
    - "Template rendering validates all required variables are provided"
    - "Only the needed guideline loads (not all files at once)"
  artifacts:
    - path: "gsd/scripts/template-renderer.js"
      provides: "Template rendering with YAML frontmatter and variable validation"
      exports: ["renderTemplate"]
      min_lines: 50
    - path: "gsd/scripts/guideline-loader.js"
      provides: "Modular guideline loading by workflow name"
      exports: ["loadGuideline"]
      min_lines: 30
  key_links:
    - from: "template-renderer.js"
      to: "front-matter"
      via: "import statement"
      pattern: "import.*front-matter"
    - from: "guideline-loader.js"
      to: "gsd/.gsd-config.json"
      via: "workflow mapping"
      pattern: "workflows\\[workflowName\\]"
---

<objective>
Implement template rendering with variable validation and modular guideline loading, enabling artifact generation and context-efficient workflow execution.

Purpose: Fulfill CORE-03 (template system), CORE-04 (modular guideline loading), SCRIPT-02 (guideline loader), and SCRIPT-03 (template renderer). Modular loading is critical for staying within Tabnine's context window constraints.

Output: Two modules enabling template-based artifact generation and selective guideline loading.
</objective>

<execution_context>
@C:\Projects\GSDForTabnine\.planning\phases\02-core-infrastructure\02-RESEARCH.md
@C:\Projects\GSDForTabnine\gsd\.gsd-config.json
</execution_context>

<context>
@C:\Projects\GSDForTabnine\.planning\PROJECT.md
@C:\Projects\GSDForTabnine\.planning\ROADMAP.md
@C:\Projects\GSDForTabnine\gsd\scripts\file-ops.js
@C:\Projects\GSDForTabnine\gsd\templates\STATE.md
@C:\Projects\GSDForTabnine\gsd\guidelines\new-project.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create template-renderer.js with variable validation</name>
  <files>gsd/scripts/template-renderer.js</files>
  <action>
Create gsd/scripts/template-renderer.js for rendering templates with variable substitution:

**Import dependencies:**
```javascript
import fm from 'front-matter';
import { readFile } from './file-ops.js';
import path from 'node:path';
```

**Export async function renderTemplate(templateName, variables, templatesDir):**

Implements the template rendering pattern from RESEARCH.md:

1. **Load template file:**
   - Construct path: `path.join(templatesDir, ${templateName}.md)`
   - Read file using file-ops.js readFile()

2. **Parse YAML frontmatter:**
   - Use front-matter library: `const { attributes, body } = fm(templateContent)`
   - Extract variables array from attributes: `attributes.variables || []`

3. **Validate required variables:**
   - Get required variables from frontmatter: `requiredVars = attributes.variables`
   - Check all required variables provided: `const missing = requiredVars.filter(v => !(v in variables))`
   - If missing variables exist, throw error:
     `Template ${templateName} requires missing variables: ${missing.join(', ')}`

4. **Render using template literals:**
   - Use Function constructor (safe since templates are controlled, not user-provided):
     ```javascript
     const varNames = Object.keys(variables);
     const varValues = Object.values(variables);
     const renderFn = new Function(...varNames, `return \`${body}\`;`);
     const rendered = renderFn(...varValues);
     ```
   - This evaluates ${varName} placeholders in template body

5. **Return rendered content:**
   - Return string with all variables substituted

**Why Function constructor (from RESEARCH.md):**
- Native template literal syntax (no external library)
- Variables in controlled scope (not global eval)
- Safe since templates are from gsd/templates/ (not user input)
- Supports expressions, not just simple substitution

**Export async function listTemplates(templatesDir):**

Helper function to discover available templates:

1. Read directory contents
2. Filter for .md files
3. Return array of template names (without .md extension)

**Error handling:**
- Clear error if template not found: `Template not found: ${templateName}`
- Clear error for missing variables (list all missing, not just first)
- Validation happens BEFORE rendering (fail fast)

**Anti-patterns to avoid:**
- String.replace() loops (use template literals via Function)
- Missing variable validation (silent failures)
- Using eval() directly (security risk)
  </action>
  <verify>
```bash
cd C:/Projects/GSDForTabnine
node --input-type=module -e "
import { renderTemplate } from './gsd/scripts/template-renderer.js';

// Test with STATE.md template
const rendered = await renderTemplate('STATE', {
  projectName: 'Test Project',
  lastUpdated: '2026-01-18',
  version: '1.0.0',
  coreValue: 'Test core value',
  currentFocus: 'Testing',
  currentPhase: 1,
  currentPlan: 1,
  status: 'pending',
  currentStep: 'Test step',
  progressIndicator: '█░░░',
  totalPhases: 4,
  completedPhases: 1,
  totalRequirements: 55,
  validatedRequirements: 19,
  successRate: '100%',
  keyDecisions: 'Test decision',
  activeTodos: 'Test todo',
  knownBlockers: 'None',
  recentChanges: 'Test change',
  lastAction: 'Test action',
  nextAction: 'Test next',
  contextNeeded: 'Test context',
  resumeInstructions: 'Test instructions'
}, 'gsd/templates');

console.log('Rendered length:', rendered.length > 100);
console.log('Contains project name:', rendered.includes('Test Project'));
"
```

Expected: Template renders successfully, includes substituted variables.
  </verify>
  <done>template-renderer.js exports renderTemplate and listTemplates; parses YAML frontmatter; validates variables; substitutes using template literals</done>
</task>

<task type="auto">
  <name>Task 2: Create guideline-loader.js for modular loading</name>
  <files>gsd/scripts/guideline-loader.js</files>
  <action>
Create gsd/scripts/guideline-loader.js for loading workflow guidelines by name:

**Import dependencies:**
```javascript
import { readFile } from './file-ops.js';
import path from 'node:path';
```

**Export async function loadGuideline(workflowName, configPath = 'gsd/.gsd-config.json'):**

Implements modular guideline loading from RESEARCH.md:

1. **Load config file:**
   - Read configPath using file-ops.js readFile()
   - Parse JSON: `const config = JSON.parse(configContent)`

2. **Find guideline file for workflow:**
   - Look up workflow in config: `const guidelineFile = config.workflows[workflowName]`
   - If not found, throw error:
     `Unknown workflow: ${workflowName}. Available workflows: ${Object.keys(config.workflows).join(', ')}`

3. **Construct guideline path:**
   - Get guidelines directory from config: `config.paths.guidelines`
   - Build full path: `path.join(config.paths.guidelines, guidelineFile)`

4. **Load and return guideline content:**
   - Read guideline file using file-ops.js readFile()
   - Return content as string (markdown with YAML frontmatter)

**Export async function listWorkflows(configPath = 'gsd/.gsd-config.json'):**

Helper function to discover available workflows:

1. Load config file
2. Return array of workflow names: `Object.keys(config.workflows)`

**Why modular loading (from ROADMAP.md):**
- Tabnine has smaller context window than Claude Code
- Loading all guidelines at once exceeds context limits
- Load only the guideline needed for current workflow phase
- Reduces token usage by 70-80% compared to loading all files

**Usage examples (in comments):**
```javascript
// Load planning guideline only when planning
// const planGuideline = await loadGuideline('planPhase');

// Load execution guideline only when executing
// const execGuideline = await loadGuideline('executePhase');

// Workflows: newProject, planPhase, executePhase, verifyWork
```

**Error handling:**
- Config file not found: `Config file not found: ${configPath}`
- Invalid JSON: `Invalid config file (JSON parse error)`
- Unknown workflow: List available workflows in error message
- Guideline file not found: `Guideline file not found: ${guidelinePath}`

**Anti-patterns to avoid:**
- Loading all guidelines at once (import * from 'gsd/guidelines')
- Hardcoding guideline paths (use config.workflows mapping)
- Missing workflow name validation (fail fast with available options)
  </action>
  <verify>
```bash
cd C:/Projects/GSDForTabnine
node --input-type=module -e "
import { loadGuideline, listWorkflows } from './gsd/scripts/guideline-loader.js';

// List available workflows
const workflows = await listWorkflows();
console.log('Available workflows:', workflows.length === 4);

// Load single guideline
const newProjectGuideline = await loadGuideline('newProject');
console.log('Loaded guideline length:', newProjectGuideline.length > 100);
console.log('Contains frontmatter:', newProjectGuideline.includes('---'));
console.log('Contains workflow name:', newProjectGuideline.includes('new-project'));
"
```

Expected: 4 workflows available, guideline loads successfully, contains YAML frontmatter.
  </verify>
  <done>guideline-loader.js exports loadGuideline and listWorkflows; loads single guideline by name; uses config mapping; validates workflow names</done>
</task>

</tasks>

<verification>
1. template-renderer.js uses front-matter library for YAML parsing
2. template-renderer.js validates all required variables before rendering
3. template-renderer.js uses Function constructor for template literal evaluation
4. guideline-loader.js loads config from .gsd-config.json
5. guideline-loader.js loads only the requested guideline (not all files)
6. Both modules use file-ops.js for file reading
7. Clear error messages for missing variables and unknown workflows
</verification>

<success_criteria>
- template-renderer.js can render STATE.md template with variables
- Missing template variables are caught and reported clearly
- guideline-loader.js can load individual guidelines by workflow name
- Only one guideline loads per call (modular loading working)
- Requirements CORE-03 (templates), CORE-04 (modular loading), SCRIPT-02 (guideline loader), SCRIPT-03 (template renderer) fulfilled
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-infrastructure/02-04-SUMMARY.md` documenting:
- template-renderer.js variable validation and substitution logic
- guideline-loader.js modular loading implementation
- Test results showing template rendering and guideline loading
- Context window savings from modular loading (estimate 70-80% reduction)
- Requirements fulfilled: CORE-03, CORE-04, SCRIPT-02, SCRIPT-03
</output>
