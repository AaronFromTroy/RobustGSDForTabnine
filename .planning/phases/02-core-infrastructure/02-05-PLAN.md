---
phase: 02-core-infrastructure
plan: 05
type: execute
wave: 4
depends_on:
  - 02-03
  - 02-04
files_modified:
  - gsd/scripts/integration-test.js
autonomous: false

must_haves:
  truths:
    - "All scripts work together in realistic workflow"
    - "Scripts work on Windows, macOS, and Linux"
    - "Error handling provides clear, actionable messages"
    - "Documentation includes usage examples and troubleshooting"
  artifacts:
    - path: "gsd/scripts/integration-test.js"
      provides: "Integration test validating all Phase 2 modules"
      min_lines: 80
  key_links:
    - from: "integration-test.js"
      to: "all Phase 2 modules"
      via: "import statements"
      pattern: "state-manager|template-renderer|guideline-loader|file-ops|process-runner"
---

<objective>
Validate that all Phase 2 modules work together correctly through integration testing and cross-platform verification, ensuring the core infrastructure is production-ready.

Purpose: Fulfill SCRIPT-04 (cross-platform patterns), SCRIPT-06 (error handling), and CORE-01 (sequential workflow orchestration foundation). Integration testing catches wiring issues before Phase 3 orchestration.

Output: Integration test script validating end-to-end workflows and cross-platform compatibility.
</objective>

<execution_context>
@C:\Projects\GSDForTabnine\.planning\phases\02-core-infrastructure\02-RESEARCH.md
</execution_context>

<context>
@C:\Projects\GSDForTabnine\.planning\PROJECT.md
@C:\Projects\GSDForTabnine\.planning\ROADMAP.md
@C:\Projects\GSDForTabnine\gsd\scripts\state-manager.js
@C:\Projects\GSDForTabnine\gsd\scripts\template-renderer.js
@C:\Projects\GSDForTabnine\gsd\scripts\guideline-loader.js
@C:\Projects\GSDForTabnine\gsd\scripts\file-ops.js
@C:\Projects\GSDForTabnine\gsd\scripts\process-runner.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create integration test script</name>
  <files>gsd/scripts/integration-test.js</files>
  <action>
Create gsd/scripts/integration-test.js to validate all Phase 2 modules work together:

**Import all Phase 2 modules:**
```javascript
import { readFile, writeFileAtomic, fileExists, ensureDir } from './file-ops.js';
import { runCommand } from './process-runner.js';
import { readState, writeState, generateProgressIndicator, STATUS_VALUES } from './state-manager.js';
import { renderTemplate, listTemplates } from './template-renderer.js';
import { loadGuideline, listWorkflows } from './guideline-loader.js';
import path from 'node:path';
```

**Test Suite 1: File Operations**
1. Test writeFileAtomic creates file with content
2. Test readFile returns correct content
3. Test fileExists detects existing and missing files
4. Test ensureDir creates directory structure
5. Clean up test files

**Test Suite 2: Process Runner**
1. Test runCommand with successful command (`node --version`)
2. Test runCommand with failing command (non-existent command)
3. Verify error handling for process errors
4. Verify stdout/stderr capture

**Test Suite 3: State Manager**
1. Test readState parses current STATE.md
2. Test generateProgressIndicator produces correct bars (2/4 → `██░░`)
3. Test validateStateData rejects invalid states
4. Test validateStateData accepts valid states
5. Log parsed state fields (phase, plan, status)

**Test Suite 4: Template Renderer**
1. Test listTemplates discovers all templates
2. Test renderTemplate with valid variables
3. Test renderTemplate rejects missing variables
4. Verify substitution works (check output contains substituted values)

**Test Suite 5: Guideline Loader**
1. Test listWorkflows returns all 4 workflows
2. Test loadGuideline loads each workflow successfully
3. Test loadGuideline rejects unknown workflow name
4. Verify guideline content has YAML frontmatter

**Test Suite 6: Cross-Platform Path Handling**
1. Test path.join works with mixed separators
2. Test file operations work with paths containing spaces (if any)
3. Log current platform: `process.platform`
4. Verify no hardcoded path separators in any module

**Output format:**
- Log each test suite name
- Log pass/fail for each test
- Count total tests passed/failed
- Exit with code 0 if all pass, 1 if any fail

**Run all tests sequentially:**
- Use try/catch for each test
- Continue on failure (don't abort entire suite)
- Accumulate failures for final report

**Usage:**
```bash
node gsd/scripts/integration-test.js
```

**Anti-patterns to avoid:**
- Aborting on first failure (run all tests)
- Not cleaning up test files
- Hardcoded absolute paths in tests
  </action>
  <verify>
```bash
cd C:/Projects/GSDForTabnine
node gsd/scripts/integration-test.js
```

Expected: All test suites run, majority of tests pass, clear pass/fail output, exit code 0 if all pass.
  </verify>
  <done>integration-test.js exists and validates all Phase 2 modules; runs complete test suite; provides clear pass/fail output</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 2 core infrastructure: package.json with dependencies, file-ops.js, process-runner.js, state-manager.js, template-renderer.js, guideline-loader.js, integration-test.js.

All modules use ESM syntax, atomic writes (write-file-atomic), safe child processes (spawn), cross-platform paths (path module), and proper error handling.
  </what-built>

  <how-to-verify>
**1. Verify integration tests pass:**
```bash
cd C:/Projects/GSDForTabnine
node gsd/scripts/integration-test.js
```
Expected: All test suites complete, majority pass, exit code 0.

**2. Verify all Phase 2 files exist:**
```bash
ls gsd/package.json
ls gsd/scripts/file-ops.js
ls gsd/scripts/process-runner.js
ls gsd/scripts/state-manager.js
ls gsd/scripts/template-renderer.js
ls gsd/scripts/guideline-loader.js
ls gsd/scripts/integration-test.js
```
Expected: All 7 files exist.

**3. Verify dependencies installed:**
```bash
ls gsd/node_modules/write-file-atomic
ls gsd/node_modules/ajv
ls gsd/node_modules/front-matter
```
Expected: All 3 packages present.

**4. Test manual workflow simulation:**
```bash
node --input-type=module -e "
import { loadGuideline } from './gsd/scripts/guideline-loader.js';
import { readState } from './gsd/scripts/state-manager.js';
import { renderTemplate } from './gsd/scripts/template-renderer.js';

console.log('Loading guideline...');
const guideline = await loadGuideline('planPhase');
console.log('Guideline loaded:', guideline.length, 'chars');

console.log('Reading state...');
const state = await readState('.');
console.log('Current phase:', state.phase, 'Status:', state.status);

console.log('All core infrastructure working!');
"
```
Expected: Guideline loads, state reads, no errors.

**5. Cross-platform verification (if on Windows):**
- Check integration test passes on Windows
- Verify path operations use path.join() (no hardcoded `\\` or `/`)
- Confirm git and npm commands work via process-runner

**6. Review error handling:**
Try loading non-existent workflow:
```bash
node --input-type=module -e "
import { loadGuideline } from './gsd/scripts/guideline-loader.js';
try {
  await loadGuideline('nonExistent');
} catch (err) {
  console.log('Error message:', err.message);
  console.log('Includes available workflows:', err.message.includes('Available'));
}
"
```
Expected: Clear error message listing available workflows.
  </how-to-verify>

  <resume-signal>
After verifying all tests pass and manual workflow simulation works:
- Type "approved" to continue to Phase 2 summary
- If issues found, describe them for remediation
  </resume-signal>
</task>

</tasks>

<verification>
1. Integration test script runs all test suites
2. Test coverage includes all Phase 2 modules
3. Cross-platform path handling verified (path.join used)
4. Error messages are clear and actionable
5. Manual workflow simulation works end-to-end
6. Dependencies correctly installed and importable
7. All scripts use ESM syntax with node: protocol
</verification>

<success_criteria>
- Integration tests pass on current platform
- All 6 Phase 2 modules exist and are importable
- Manual workflow simulation (load guideline + read state + render template) succeeds
- Error handling provides clear messages with available options
- Requirements CORE-01 (workflow foundation), SCRIPT-04 (cross-platform), SCRIPT-06 (error handling) fulfilled
- All 17 Phase 2 requirements complete
</success_criteria>

<output>
After completion and verification approval, create `.planning/phases/02-core-infrastructure/02-05-SUMMARY.md` documenting:
- Integration test results (test suites passed/failed)
- Cross-platform verification status
- Manual workflow simulation success
- Error handling examples
- Complete list of Phase 2 deliverables
- Requirements fulfilled: All CORE, SCRIPT, PROG requirements (17 total)
- Known issues or platform-specific notes
- Phase 2 completion confirmation
</output>
