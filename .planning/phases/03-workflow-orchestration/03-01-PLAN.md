---
phase: 03-workflow-orchestration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - gsd/scripts/trigger-detector.js
autonomous: true

must_haves:
  truths:
    - "System detects exact phrase 'start GSD' and 'continue GSD workflow'"
    - "System shows visual confirmation box before activating workflow"
    - "System prevents 'start GSD' when workflow already exists"
    - "System handles exact phrase matching case-insensitively"
  artifacts:
    - path: "gsd/scripts/trigger-detector.js"
      provides: "Trigger detection with exact phrase matching and confirmation"
      min_lines: 100
      exports: ["detectTrigger", "confirmTrigger", "checkWorkflowConflict"]
  key_links:
    - from: "gsd/scripts/trigger-detector.js"
      to: "gsd/.gsd-config.json"
      via: "readFile and JSON.parse"
      pattern: "readFile.*\\.gsd-config\\.json"
    - from: "gsd/scripts/trigger-detector.js"
      to: "state-manager.js"
      via: "import readState"
      pattern: "import.*readState.*from.*state-manager"
---

<objective>
Create trigger detection system that recognizes exact workflow phrases ("start GSD", "continue GSD workflow") with visual confirmation and conflict prevention.

Purpose: Enable natural language workflow activation while preventing false positives and workflow conflicts.
Output: trigger-detector.js module providing exact phrase matching, confirmation prompts, and conflict detection.
</objective>

<execution_context>
@C:\Projects\GSDForTabnine\.claude\get-shit-done\workflows\execute-plan.md
@C:\Projects\GSDForTabnine\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@C:\Projects\GSDForTabnine\.planning\PROJECT.md
@C:\Projects\GSDForTabnine\.planning\ROADMAP.md
@C:\Projects\GSDForTabnine\.planning\STATE.md
@C:\Projects\GSDForTabnine\.planning\phases\03-workflow-orchestration\03-CONTEXT.md
@C:\Projects\GSDForTabnine\.planning\phases\03-workflow-orchestration\03-RESEARCH.md
@C:\Projects\GSDForTabnine\.planning\phases\02-core-infrastructure\02-05-SUMMARY.md
@C:\Projects\GSDForTabnine\gsd\.gsd-config.json
@C:\Projects\GSDForTabnine\gsd\scripts\state-manager.js
@C:\Projects\GSDForTabnine\gsd\scripts\file-ops.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create trigger-detector.js with exact phrase matching</name>
  <files>gsd/scripts/trigger-detector.js</files>
  <action>
Create trigger-detector.js implementing exact phrase matching for workflow triggers.

**Core functions:**

1. **detectTrigger(userInput, config)** - Exact phrase matching
   - Normalize input: `userInput.trim().toLowerCase()`
   - Match against config.triggerPhrases.start array (exact match only)
   - Match against config.triggerPhrases.continue array (exact match only)
   - Return: `{ type: 'START'|'CONTINUE', phrase: string } | null`
   - DO NOT use fuzzy matching, substring matching, or NLP (CONTEXT.md: "exact match only")

2. **loadTriggerConfig(projectRoot)** - Load trigger phrases from config
   - Read .gsd-config.json using file-ops.js readFile()
   - Parse JSON
   - Return config.triggerPhrases object
   - Handle missing config with clear error: "Configuration file not found at gsd/.gsd-config.json"

3. **confirmTrigger(triggerResult)** - Generate confirmation prompt
   - Create visual box format (CONTEXT.md: "box/banner with icon")
   - Example format:
     ```
     ðŸ”µ GSD Trigger Detected

     Phrase: "start GSD"
     Action: Start new workflow

     Continue? (yes/no)
     ```
   - Return confirmation message string
   - Include trigger type and detected phrase

4. **checkWorkflowConflict(projectRoot, triggerType)** - Prevent conflicts
   - Use state-manager.js readState() to check for existing workflow
   - If triggerType === 'START' and workflow exists (state.phase > 0):
     - Return conflict message: "Workflow already in progress at Phase X. Use 'continue GSD workflow' to resume or complete current first."
   - If triggerType === 'CONTINUE' and no workflow exists:
     - Return error: "No active workflow found. Use 'start GSD' to begin a new project."
   - Return null if no conflict

**Imports:**
- Use `import { readFile } from './file-ops.js'`
- Use `import { readState } from './state-manager.js'`
- Use `import path from 'node:path'`

**Error handling:**
- All errors should include remediation guidance
- Use try/catch for file operations
- Return descriptive error objects: `{ error: true, message: string }`

**WHY exact matching:** Fuzzy matching creates false positives during normal conversation. Exact phrases with confirmation prevent accidental workflow activation (RESEARCH.md pitfall #4).
  </action>
  <verify>
```bash
# Test trigger detection
node -e "
import { detectTrigger, loadTriggerConfig, confirmTrigger, checkWorkflowConflict } from './gsd/scripts/trigger-detector.js';

// Test exact match (should detect)
const config = { triggerPhrases: { start: ['start GSD'], continue: ['continue GSD workflow'] } };
const result1 = detectTrigger('start GSD', config);
console.log('Test 1 (exact match):', result1?.type === 'START' ? 'PASS' : 'FAIL');

// Test case insensitive (should detect)
const result2 = detectTrigger('START GSD', config);
console.log('Test 2 (case insensitive):', result2?.type === 'START' ? 'PASS' : 'FAIL');

// Test fuzzy match (should NOT detect)
const result3 = detectTrigger('I want to start GSD soon', config);
console.log('Test 3 (no fuzzy match):', result3 === null ? 'PASS' : 'FAIL');

// Test confirmation format
const confirm = confirmTrigger({ type: 'START', phrase: 'start GSD' });
console.log('Test 4 (confirmation):', confirm.includes('ðŸ”µ') ? 'PASS' : 'FAIL');
"
```

All 4 tests should PASS.
  </verify>
  <done>
- trigger-detector.js exists with 4 exported functions
- Exact phrase matching implemented (case-insensitive, no fuzzy logic)
- Confirmation prompts use visual box format with icon
- Conflict detection prevents dual workflows
- All tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Add integration tests for trigger detection</name>
  <files>gsd/scripts/integration-test.js</files>
  <action>
Add Test Suite 7 to integration-test.js for trigger detection.

**Insert after Test Suite 6 (line ~400 in integration-test.js):**

```javascript
// === Test Suite 7: Trigger Detection ===
console.log('\n=== Test Suite 7: Trigger Detection ===');

try {
  const { detectTrigger, confirmTrigger, checkWorkflowConflict } = await import('./trigger-detector.js');

  // Test 1: Exact phrase matching (START)
  const config = { triggerPhrases: { start: ['start GSD'], continue: ['continue GSD workflow'] } };
  const result1 = detectTrigger('start GSD', config);
  if (result1?.type === 'START' && result1?.phrase === 'start GSD') {
    console.log('  âœ“ Exact phrase matching (START)');
    testsPassed++;
  } else {
    console.log('  âœ— Exact phrase matching (START) - FAILED');
    testsFailed++;
    failures.push('Trigger detection: exact START match failed');
  }

  // Test 2: Case insensitive matching
  const result2 = detectTrigger('START GSD', config);
  if (result2?.type === 'START') {
    console.log('  âœ“ Case insensitive matching');
    testsPassed++;
  } else {
    console.log('  âœ— Case insensitive matching - FAILED');
    testsFailed++;
    failures.push('Trigger detection: case insensitive match failed');
  }

  // Test 3: Fuzzy matching rejected
  const result3 = detectTrigger('I want to start GSD soon', config);
  if (result3 === null) {
    console.log('  âœ“ Fuzzy matching rejected');
    testsPassed++;
  } else {
    console.log('  âœ— Fuzzy matching rejected - FAILED');
    testsFailed++;
    failures.push('Trigger detection: fuzzy match incorrectly accepted');
  }

  // Test 4: CONTINUE trigger detection
  const result4 = detectTrigger('continue GSD workflow', config);
  if (result4?.type === 'CONTINUE') {
    console.log('  âœ“ CONTINUE trigger detection');
    testsPassed++;
  } else {
    console.log('  âœ— CONTINUE trigger detection - FAILED');
    testsFailed++;
    failures.push('Trigger detection: CONTINUE match failed');
  }

  // Test 5: Confirmation format includes icon
  const confirmation = confirmTrigger({ type: 'START', phrase: 'start GSD' });
  if (confirmation.includes('ðŸ”µ') && confirmation.includes('GSD Trigger Detected')) {
    console.log('  âœ“ Confirmation format includes icon');
    testsPassed++;
  } else {
    console.log('  âœ— Confirmation format includes icon - FAILED');
    testsFailed++;
    failures.push('Trigger detection: confirmation format invalid');
  }

} catch (error) {
  console.log('  âœ— Trigger detection tests - ERROR:', error.message);
  testsFailed += 5;
  failures.push(`Trigger detection error: ${error.message}`);
}
```

**Update test counts at top of file:**
- Change "Total tests: 27" to "Total tests: 32"
- Tests now: 27 (Phase 2) + 5 (trigger detection) = 32
  </action>
  <verify>
```bash
node gsd/scripts/integration-test.js
```

Should show:
- Test Suite 7: Trigger Detection (5 tests)
- Total tests: 32
- Passed: 32 (100%)
  </verify>
  <done>
- integration-test.js includes Test Suite 7 with 5 trigger detection tests
- All 32 tests pass (27 Phase 2 + 5 new)
- Tests cover exact matching, case insensitivity, fuzzy rejection, CONTINUE detection, confirmation format
  </done>
</task>

</tasks>

<verification>
**Functional checks:**
1. Trigger detection works: `node -e "import { detectTrigger } from './gsd/scripts/trigger-detector.js'; console.log(detectTrigger('start GSD', {triggerPhrases: {start: ['start GSD'], continue: []}}));"` returns `{type: 'START', phrase: 'start GSD'}`
2. Integration tests pass: `node gsd/scripts/integration-test.js` shows 32/32 passed
3. Conflict detection prevents dual workflows
4. Confirmation prompts include visual indicator (ðŸ”µ)

**Requirements validated:**
- TRIG-01: Detects "start GSD" âœ“
- TRIG-02: Detects "continue GSD workflow" âœ“
- TRIG-03: Supports trigger phrase variations (from config) âœ“
- TRIG-04: Confirms trigger before activating âœ“
</verification>

<success_criteria>
- [ ] trigger-detector.js exists with 4 exported functions
- [ ] Exact phrase matching implemented (no fuzzy logic)
- [ ] Confirmation prompts use visual box format (ðŸ”µ icon)
- [ ] Conflict detection prevents starting when workflow exists
- [ ] All 32 integration tests pass (27 Phase 2 + 5 trigger detection)
- [ ] Requirements TRIG-01 through TRIG-04 fulfilled
</success_criteria>

<output>
After completion, create `.planning/phases/03-workflow-orchestration/03-01-SUMMARY.md`
</output>
