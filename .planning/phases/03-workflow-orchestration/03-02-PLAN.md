---
phase: 03-workflow-orchestration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - gsd/scripts/validator.js
  - gsd/package.json
autonomous: true

must_haves:
  truths:
    - "System validates artifact structure before marking phase complete"
    - "System checks required sections exist in markdown files"
    - "System validates YAML frontmatter against schemas"
    - "System provides specific error messages with line numbers and remediation"
    - "System verifies 100% requirement coverage in roadmap"
  artifacts:
    - path: "gsd/scripts/validator.js"
      provides: "Artifact validation with schema and structure checking"
      min_lines: 200
      exports: ["validateArtifact", "validateRequirementCoverage", "validateStateStructure"]
  key_links:
    - from: "gsd/scripts/validator.js"
      to: "ajv"
      via: "import and schema validation"
      pattern: "import.*Ajv.*from.*ajv"
    - from: "gsd/scripts/validator.js"
      to: "front-matter"
      via: "import and frontmatter parsing"
      pattern: "import.*frontmatter.*from.*front-matter"
    - from: "gsd/scripts/validator.js"
      to: "file-ops.js"
      via: "readFile for artifact content"
      pattern: "import.*readFile.*from.*file-ops"
---

<objective>
Create validation system that checks artifact structure (required sections), validates metadata schemas, and verifies requirement coverage before phase completion.

Purpose: Prevent invalid phase transitions and ensure all artifacts meet quality standards.
Output: validator.js module providing two-layer validation (schema + structure) with specific error messages and remediation.
</objective>

<execution_context>
@C:\Projects\GSDForTabnine\.claude\get-shit-done\workflows\execute-plan.md
@C:\Projects\GSDForTabnine\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@C:\Projects\GSDForTabnine\.planning\PROJECT.md
@C:\Projects\GSDForTabnine\.planning\ROADMAP.md
@C:\Projects\GSDForTabnine\.planning\STATE.md
@C:\Projects\GSDForTabnine\.planning\phases\03-workflow-orchestration\03-CONTEXT.md
@C:\Projects\GSDForTabnine\.planning\phases\03-workflow-orchestration\03-RESEARCH.md
@C:\Projects\GSDForTabnine\.planning\phases\02-core-infrastructure\02-05-SUMMARY.md
@C:\Projects\GSDForTabnine\gsd\scripts\file-ops.js
@C:\Projects\GSDForTabnine\gsd\scripts\state-manager.js
@C:\Projects\GSDForTabnine\gsd\package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install markdownlint dependency</name>
  <files>gsd/package.json</files>
  <action>
Install markdownlint for markdown structure validation (RESEARCH.md recommendation).

```bash
cd gsd
npm install markdownlint@0.36.1
```

**Why markdownlint:** Industry standard (20M+ downloads/month) for markdown validation. Validates CommonMark + GitHub Flavored Markdown. Prevents structural inconsistencies (RESEARCH.md: "Don't hand-roll markdown linting").

**Verify installation:**
- Check package.json dependencies includes "markdownlint": "^0.36.1"
- Check node_modules/markdownlint exists
  </action>
  <verify>
```bash
cat gsd/package.json | grep markdownlint
ls gsd/node_modules/markdownlint/
```

Both commands should succeed.
  </verify>
  <done>
- package.json includes markdownlint@0.36.1 dependency
- node_modules/markdownlint directory exists
  </done>
</task>

<task type="auto">
  <name>Task 2: Create validator.js with two-layer validation</name>
  <files>gsd/scripts/validator.js</files>
  <action>
Create validator.js implementing two-layer validation: JSON Schema (metadata) + structure checking (required sections).

**Core functions:**

1. **validateArtifact(projectRoot, filePath, artifactType)** - Two-layer validation
   - Layer 1: Parse YAML frontmatter with front-matter library
   - Validate frontmatter against schema for artifactType using Ajv
   - If validation fails: throw with clear error including which field failed and why
   - Layer 2: Check required sections exist in markdown body
   - Use regex pattern: `new RegExp('^## ' + escapeRegex(sectionName) + '$', 'm')`
   - If section missing: estimate line number, provide remediation command
   - Error format: "Missing section: Core Value (expected around line 5). Fix: echo '## Core Value' >> PROJECT.md"
   - Return true if both layers pass

2. **validateRequirementCoverage(projectRoot)** - Verify 100% coverage
   - Read REQUIREMENTS.md using file-ops.js readFile()
   - Extract requirement IDs using regex: `/\*\*([A-Z]+-\d+)\*\*:/g`
   - Read ROADMAP.md
   - Extract traced requirement IDs from traceability table: `/\|\s*([A-Z]+-\d+)\s*\|/g`
   - Find orphaned requirements: `requirementIds.filter(id => !tracedIds.includes(id))`
   - If orphaned.length > 0: throw error listing orphaned IDs with remediation
   - Return coverage object: `{ total, traced, orphaned, percentage }`

3. **validateStateStructure(stateData)** - Validate STATE.md schema
   - Reuse validation logic from state-manager.js validateStateData()
   - Add additional checks for STATE.md specific fields
   - Verify phase number is valid (> 0)
   - Verify status is one of STATUS_VALUES
   - Verify required fields exist: phase, plan, status, step
   - Return validation result: `{ valid: boolean, errors: string[] }`

4. **ARTIFACT_SCHEMAS constant** - Schema definitions
   ```javascript
   const ARTIFACT_SCHEMAS = {
     'PROJECT.md': {
       requiredSections: ['What This Is', 'Core Value', 'Requirements', 'Context', 'Constraints'],
       metadataSchema: {
         type: 'object',
         required: ['version', 'created', 'core_value'],
         properties: {
           version: { type: 'string', pattern: '^\\d+\\.\\d+\\.\\d+$' },
           created: { type: 'string' },
           core_value: { type: 'string', minLength: 10 }
         }
       }
     },
     'ROADMAP.md': {
       requiredSections: ['Overview', 'Phases', 'Progress', 'Dependencies'],
       metadataSchema: {
         type: 'object',
         required: ['version', 'created', 'depth'],
         properties: {
           version: { type: 'string', pattern: '^\\d+\\.\\d+\\.\\d+$' },
           depth: { enum: ['Quick', 'Standard', 'Deep'] }
         }
       }
     },
     'REQUIREMENTS.md': {
       requiredSections: ['v1 Requirements', 'Traceability'],
       metadataSchema: {
         type: 'object',
         required: ['version', 'created'],
         properties: {
           version: { type: 'string', pattern: '^\\d+\\.\\d+\\.\\d+$' }
         }
       }
     }
   };
   ```

**Helper functions:**
- `escapeRegex(str)` - Escape regex special characters
- `estimateLineNumber(content, sectionName)` - Find approximate line for missing section

**Imports:**
- `import Ajv from 'ajv'`
- `import frontmatter from 'front-matter'`
- `import { readFile } from './file-ops.js'`
- `import path from 'node:path'`

**Error handling:**
- Accumulate all errors before throwing (don't fail on first error)
- Provide specific remediation for each error type
- Include file paths and line numbers in error messages

**WHY two-layer validation:** JSON Schema handles metadata structure, but markdown section validation requires custom regex (RESEARCH.md Pattern 4). Combining both ensures complete artifact validation.
  </action>
  <verify>
```bash
# Test artifact validation
node -e "
import { validateArtifact, validateRequirementCoverage } from './gsd/scripts/validator.js';

// Test validation against actual PROJECT.md
try {
  await validateArtifact(process.cwd(), '.planning/PROJECT.md', 'PROJECT.md');
  console.log('Test 1 (PROJECT.md validation): PASS');
} catch (error) {
  console.log('Test 1 (PROJECT.md validation): FAIL -', error.message);
}

// Test requirement coverage
try {
  const coverage = await validateRequirementCoverage(process.cwd());
  console.log('Test 2 (requirement coverage):', coverage.percentage === 100 ? 'PASS' : 'FAIL');
} catch (error) {
  console.log('Test 2 (requirement coverage): FAIL -', error.message);
}
"
```

Both tests should PASS (PROJECT.md and REQUIREMENTS.md exist and are valid).
  </verify>
  <done>
- validator.js exists with 3 exported functions
- Two-layer validation implemented (schema + structure)
- ARTIFACT_SCHEMAS defines validation rules for PROJECT.md, ROADMAP.md, REQUIREMENTS.md
- Error messages include line numbers and remediation commands
- Requirement coverage validation detects orphaned requirements
- All verification tests pass
  </done>
</task>

<task type="auto">
  <name>Task 3: Add integration tests for validation</name>
  <files>gsd/scripts/integration-test.js</files>
  <action>
Add Test Suite 8 to integration-test.js for artifact validation.

**Insert after Test Suite 7:**

```javascript
// === Test Suite 8: Artifact Validation ===
console.log('\n=== Test Suite 8: Artifact Validation ===');

try {
  const { validateArtifact, validateRequirementCoverage, validateStateStructure } = await import('./validator.js');

  // Test 1: Valid PROJECT.md passes validation
  try {
    await validateArtifact(process.cwd(), '.planning/PROJECT.md', 'PROJECT.md');
    console.log('  ✓ Valid PROJECT.md passes validation');
    testsPassed++;
  } catch (error) {
    console.log('  ✗ Valid PROJECT.md passes validation - FAILED:', error.message);
    testsFailed++;
    failures.push('Validation: PROJECT.md validation failed');
  }

  // Test 2: Valid ROADMAP.md passes validation
  try {
    await validateArtifact(process.cwd(), '.planning/ROADMAP.md', 'ROADMAP.md');
    console.log('  ✓ Valid ROADMAP.md passes validation');
    testsPassed++;
  } catch (error) {
    console.log('  ✗ Valid ROADMAP.md passes validation - FAILED:', error.message);
    testsFailed++;
    failures.push('Validation: ROADMAP.md validation failed');
  }

  // Test 3: Requirement coverage validation
  try {
    const coverage = await validateRequirementCoverage(process.cwd());
    if (coverage.percentage === 100) {
      console.log('  ✓ Requirement coverage validation (100%)');
      testsPassed++;
    } else {
      console.log('  ✗ Requirement coverage validation - FAILED: ' + coverage.percentage + '%');
      testsFailed++;
      failures.push(`Validation: requirement coverage not 100% (${coverage.percentage}%)`);
    }
  } catch (error) {
    console.log('  ✗ Requirement coverage validation - FAILED:', error.message);
    testsFailed++;
    failures.push('Validation: requirement coverage check failed');
  }

  // Test 4: State structure validation (valid state)
  const validState = {
    phase: 2,
    plan: 5,
    status: 'completed',
    step: 'Integration testing'
  };
  const result4 = validateStateStructure(validState);
  if (result4.valid === true) {
    console.log('  ✓ State structure validation (valid state)');
    testsPassed++;
  } else {
    console.log('  ✗ State structure validation (valid state) - FAILED');
    testsFailed++;
    failures.push('Validation: valid state rejected');
  }

  // Test 5: State structure validation (invalid status)
  const invalidState = {
    phase: 1,
    plan: 1,
    status: 'invalid_status',
    step: 'Test'
  };
  const result5 = validateStateStructure(invalidState);
  if (result5.valid === false && result5.errors.length > 0) {
    console.log('  ✓ State structure validation (invalid status rejected)');
    testsPassed++;
  } else {
    console.log('  ✗ State structure validation (invalid status rejected) - FAILED');
    testsFailed++;
    failures.push('Validation: invalid status not rejected');
  }

} catch (error) {
  console.log('  ✗ Artifact validation tests - ERROR:', error.message);
  testsFailed += 5;
  failures.push(`Validation error: ${error.message}`);
}
```

**Update test counts:**
- Change "Total tests: 32" to "Total tests: 37"
- Tests now: 27 (Phase 2) + 5 (trigger detection) + 5 (validation) = 37
  </action>
  <verify>
```bash
node gsd/scripts/integration-test.js
```

Should show:
- Test Suite 8: Artifact Validation (5 tests)
- Total tests: 37
- Passed: 37 (100%)
  </verify>
  <done>
- integration-test.js includes Test Suite 8 with 5 validation tests
- All 37 tests pass (27 Phase 2 + 5 trigger + 5 validation)
- Tests cover PROJECT.md validation, ROADMAP.md validation, requirement coverage, state structure validation (valid and invalid)
  </done>
</task>

</tasks>

<verification>
**Functional checks:**
1. Artifact validation works: `node -e "import { validateArtifact } from './gsd/scripts/validator.js'; await validateArtifact(process.cwd(), '.planning/PROJECT.md', 'PROJECT.md'); console.log('PASS');"` prints PASS
2. Requirement coverage checks: `node -e "import { validateRequirementCoverage } from './gsd/scripts/validator.js'; const c = await validateRequirementCoverage(process.cwd()); console.log(c.percentage + '%');"` prints 100%
3. Integration tests pass: `node gsd/scripts/integration-test.js` shows 37/37 passed
4. Error messages include remediation commands

**Requirements validated:**
- VALID-01: Validates required sections in artifacts ✓
- VALID-02: Checks requirement traceability ✓
- VALID-03: Verifies STATE.md structure ✓
- VALID-04: Prevents invalid phase transitions (schema enforcement) ✓
- VALID-05: Clear validation error messages with remediation ✓
</verification>

<success_criteria>
- [ ] markdownlint@0.36.1 installed
- [ ] validator.js exists with 3 exported functions
- [ ] Two-layer validation implemented (schema + structure)
- [ ] ARTIFACT_SCHEMAS defines rules for PROJECT.md, ROADMAP.md, REQUIREMENTS.md
- [ ] Requirement coverage validation detects orphaned requirements
- [ ] Error messages include line numbers and remediation
- [ ] All 37 integration tests pass (27 Phase 2 + 5 trigger + 5 validation)
- [ ] Requirements VALID-01 through VALID-05 fulfilled
</success_criteria>

<output>
After completion, create `.planning/phases/03-workflow-orchestration/03-02-SUMMARY.md`
</output>
