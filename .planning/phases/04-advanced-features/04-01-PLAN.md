---
phase: 04-advanced-features
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - gsd/templates/STACK.md
  - gsd/templates/FEATURES.md
  - gsd/templates/ARCHITECTURE.md
  - gsd/templates/PITFALLS.md
  - gsd/templates/SUMMARY.md
  - gsd/scripts/approval-gate.js
autonomous: true

must_haves:
  truths:
    - "Workflow can pause at key decision points and present options to user"
    - "Approval decisions are logged in STATE.md with timestamp and rationale"
    - "Research templates exist with frontmatter, confidence sections, and source citations"
  artifacts:
    - path: "gsd/scripts/approval-gate.js"
      provides: "Approval gate context preparation and decision logging"
      exports: ["prepareApprovalGate", "logApprovalDecision"]
    - path: "gsd/templates/STACK.md"
      provides: "Technology stack research template"
      contains: "confidence:"
    - path: "gsd/templates/FEATURES.md"
      provides: "Feature requirements research template"
      contains: "confidence:"
    - path: "gsd/templates/ARCHITECTURE.md"
      provides: "Architecture patterns research template"
      contains: "confidence:"
    - path: "gsd/templates/PITFALLS.md"
      provides: "Common mistakes research template"
      contains: "confidence:"
    - path: "gsd/templates/SUMMARY.md"
      provides: "Research executive summary template"
      contains: "## Key Findings"
  key_links:
    - from: "gsd/scripts/approval-gate.js"
      to: "gsd/scripts/state-manager.js"
      via: "import readState, writeState"
      pattern: "import.*from.*state-manager"
    - from: "gsd/scripts/approval-gate.js"
      to: ".planning/STATE.md"
      via: "regex replacement in Key Decisions table"
      pattern: "## Key Decisions.*\\| Decision \\| Date \\| Rationale \\|"
    - from: "gsd/templates/*.md"
      to: "research-synthesizer.js"
      via: "templates loaded and rendered"
      pattern: "confidence:"
---

<objective>
Create research document templates and approval gate infrastructure to enable human-in-the-loop decision points and structured research synthesis.

Purpose: Enable production workflows where key decisions require user approval and research findings are documented with confidence levels and source citations.

Output: 5 research templates (STACK, FEATURES, ARCHITECTURE, PITFALLS, SUMMARY) and approval-gate.js script for decision logging.
</objective>

<execution_context>
@C:\Users\acous\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\acous\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@C:\Projects\GSDForTabnine\.planning\PROJECT.md
@C:\Projects\GSDForTabnine\.planning\ROADMAP.md
@C:\Projects\GSDForTabnine\.planning\STATE.md
@C:\Projects\GSDForTabnine\.planning\phases\04-advanced-features\04-RESEARCH.md
@C:\Projects\GSDForTabnine\.planning\phases\03-workflow-orchestration\03-03-SUMMARY.md
@C:\Projects\GSDForTabnine\.planning\phases\02-core-infrastructure\02-04-SUMMARY.md
@C:\Projects\GSDForTabnine\gsd\scripts\state-manager.js
@C:\Projects\GSDForTabnine\gsd\scripts\template-renderer.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create research document templates</name>
  <files>
    gsd/templates/STACK.md
    gsd/templates/FEATURES.md
    gsd/templates/ARCHITECTURE.md
    gsd/templates/PITFALLS.md
    gsd/templates/SUMMARY.md
  </files>
  <action>
Create 5 research templates following the pattern from RESEARCH.md Pattern 3 and existing templates (PROJECT.md, ROADMAP.md, etc.).

Each template must include:
1. YAML frontmatter with: type: research, topic: ${topic}, generated: ${timestamp}, confidence breakdown (high/medium/low counts)
2. Sections for High Confidence Findings, Medium Confidence Findings, Low Confidence Findings (with warning)
3. Sources section with list of source URLs
4. Template literal syntax (${variable}) for rendering with template-renderer.js

**STACK.md (Technology Stack Research):**
- Frontmatter: type, topic, generated, confidence counts
- Sections: Summary, High Confidence Findings, Medium Confidence Findings, Low Confidence Findings (with warning), Recommended Stack, Sources
- Each finding: title, source link, confidence level, content

**FEATURES.md (Feature Requirements Research):**
- Frontmatter: type, topic, generated, confidence counts
- Sections: Summary, High Confidence Findings (feature capabilities), Medium Confidence Findings, Low Confidence Findings (with warning), Feature Recommendations, Sources
- Each finding: feature name, source link, confidence level, description

**ARCHITECTURE.md (Architecture Patterns Research):**
- Frontmatter: type, topic, generated, confidence counts
- Sections: Summary, High Confidence Findings (architectural patterns), Medium Confidence Findings, Low Confidence Findings (with warning), Recommended Patterns, Anti-Patterns, Sources
- Each finding: pattern name, source link, confidence level, description

**PITFALLS.md (Common Mistakes Research):**
- Frontmatter: type, topic, generated, confidence counts
- Sections: Summary, High Confidence Findings (verified pitfalls), Medium Confidence Findings, Low Confidence Findings (with warning), How to Avoid, Sources
- Each finding: pitfall title, source link, confidence level, warning signs, remediation

**SUMMARY.md (Research Executive Summary):**
- Frontmatter: type, topic, generated, total_sources
- Sections: Executive Summary, Key Findings, Roadmap Implications, Next Steps, Sources
- Aggregate findings from all research documents

Use existing template patterns from gsd/templates/PROJECT.md for frontmatter syntax and structure.
  </action>
  <verify>
Check all 5 template files exist:
- ls gsd/templates/STACK.md gsd/templates/FEATURES.md gsd/templates/ARCHITECTURE.md gsd/templates/PITFALLS.md gsd/templates/SUMMARY.md

Verify frontmatter structure:
- grep "^---" gsd/templates/STACK.md (should find YAML frontmatter delimiters)
- grep "confidence:" gsd/templates/STACK.md (should find confidence field)

Verify template literal syntax:
- grep "\${" gsd/templates/STACK.md (should find template variables)

Verify sections exist:
- grep "## High Confidence Findings" gsd/templates/STACK.md
- grep "## Sources" gsd/templates/STACK.md
  </verify>
  <done>
All 5 research templates exist with YAML frontmatter, confidence sections (HIGH/MEDIUM/LOW), template literal syntax (${variable}), and Sources section. Templates follow existing template patterns and can be rendered by template-renderer.js.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create approval-gate.js with decision logging</name>
  <files>gsd/scripts/approval-gate.js</files>
  <action>
Create approval-gate.js following the pattern from RESEARCH.md Pattern 1 (Tabnine-Native Approval Gates) and Pattern 2 (File-Based Decision Logging).

The script must export 2 functions:

**1. prepareApprovalGate(gateName, options)**
- Parameters: gateName (string), options (array of {name, description, pros, cons, recommendation})
- Returns: {gate: string, options: array, timestamp: ISO string, status: 'presented'}
- Console output: Formatted box with = border, numbered options, pros/cons lists, recommendation if present
- Does NOT use @inquirer/prompts or any prompt library (Tabnine handles UI natively)
- Follows RESEARCH.md guidance: "Present options through clear console output, let Tabnine UI handle confirmation"

**2. logApprovalDecision(projectRoot, gateName, selectedOption, rationale)**
- Parameters: projectRoot (string), gateName (string), selectedOption (string), rationale (string)
- Uses state-manager.js readState() to load current STATE.md
- Extracts STATE.md raw content and finds "Key Decisions" table
- Appends new decision row: `| [APPROVAL GATE] ${gateName}: ${selectedOption} | ${date} | ${rationale} |`
- Uses regex replacement pattern from state-manager.js to preserve manual edits
- Uses file-ops.js writeFileAtomic() for atomic STATE.md update
- Returns: {logged: true, decision: {gateName, selectedOption, rationale}}

**Implementation details:**
- Import { readState } from './state-manager.js'
- Import { readFile, writeFileAtomic } from './file-ops.js'
- Import path from 'node:path'
- Async/await for all file operations (Phase 2 convention)
- Use regex to find Key Decisions table: /## Key Decisions\s+\| Decision \| Date \| Rationale \|\s+\|[-|]+\|[^\n]*\n((?:\|[^\n]+\n)*)/
- Date format: new Date().toISOString().split('T')[0] (YYYY-MM-DD)
- Error handling: throw descriptive errors if STATE.md missing or malformed

Do NOT install new dependencies. Use existing stack (Front-matter 4.0.2, write-file-atomic 5.0.1 already installed).
Do NOT create CLI prompts with readline or @inquirer/prompts (conflicts with Tabnine UI per RESEARCH.md Pitfall 1).
  </action>
  <verify>
Check file exists and exports:
- ls gsd/scripts/approval-gate.js
- grep "export function prepareApprovalGate" gsd/scripts/approval-gate.js
- grep "export function logApprovalDecision" gsd/scripts/approval-gate.js

Verify imports:
- grep "import.*state-manager" gsd/scripts/approval-gate.js
- grep "import.*file-ops" gsd/scripts/approval-gate.js

Verify no prohibited dependencies:
- grep -i "inquirer" gsd/scripts/approval-gate.js (should find nothing)
- grep -i "readline" gsd/scripts/approval-gate.js (should find nothing)

Verify async patterns:
- grep "async function" gsd/scripts/approval-gate.js (logApprovalDecision should be async)
- grep "await" gsd/scripts/approval-gate.js (should use await for file ops)
  </verify>
  <done>
approval-gate.js exists with prepareApprovalGate (formats and presents options) and logApprovalDecision (appends to STATE.md Key Decisions table). Script uses existing state-manager.js and file-ops.js, follows async/await patterns, and does not include CLI prompt libraries (Tabnine native UI handles approvals).
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **Template structure validation:**
   - All 5 templates exist in gsd/templates/
   - Each has YAML frontmatter with confidence fields
   - Each uses template literal syntax (${variable})
   - Each includes Sources section

2. **Approval gate validation:**
   - approval-gate.js exports prepareApprovalGate and logApprovalDecision
   - Uses existing state-manager.js and file-ops.js (no new dependencies)
   - No CLI prompt libraries imported
   - Async/await used for file operations

3. **Integration with existing infrastructure:**
   - Templates compatible with template-renderer.js (Phase 2 pattern)
   - Approval gate uses state-manager.js patterns (Phase 2 pattern)
   - File operations use writeFileAtomic (Phase 2 pattern)

Run verification commands:
```bash
# Template existence
ls gsd/templates/{STACK,FEATURES,ARCHITECTURE,PITFALLS,SUMMARY}.md

# Approval gate existence and exports
grep "export function" gsd/scripts/approval-gate.js

# No prohibited patterns
grep -i "inquirer\|readline" gsd/scripts/approval-gate.js
```
</verification>

<success_criteria>
1. All 5 research templates exist with YAML frontmatter, confidence sections, and template literal syntax
2. approval-gate.js exists with prepareApprovalGate and logApprovalDecision functions
3. Templates can be loaded by template-renderer.js (Phase 2 infrastructure)
4. Approval gate uses existing state-manager.js and file-ops.js (no new dependencies)
5. No CLI prompt libraries used (Tabnine native UI handles approvals per RESEARCH.md)
6. All file operations use async/await patterns (Phase 2 convention)
7. Approval decisions append to STATE.md Key Decisions table atomically
</success_criteria>

<output>
After completion, create `.planning/phases/04-advanced-features/04-01-SUMMARY.md` with:
- Files created (5 templates + 1 script)
- Exports from approval-gate.js
- Template structure validation results
- Integration points for Phase 4 Plan 2 (research-synthesizer.js will use these templates)
- Requirements fulfilled: HITL-01, HITL-02, HITL-03, HITL-04, HITL-05 (approval gate infrastructure complete)
</output>
