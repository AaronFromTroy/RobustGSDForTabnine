---
phase: 04-advanced-features
plan: 02
type: execute
wave: 2
depends_on: [04-01]
files_modified:
  - gsd/scripts/research-synthesizer.js
  - gsd/scripts/integration-test.js
autonomous: true

must_haves:
  truths:
    - "System can assign confidence levels to research findings based on source authority"
    - "System generates structured research documents with HIGH/MEDIUM/LOW confidence sections"
    - "All research documents include source URLs for verification"
    - "Integration tests validate both approval gates and research synthesis"
  artifacts:
    - path: "gsd/scripts/research-synthesizer.js"
      provides: "Research synthesis with confidence scoring and document generation"
      exports: ["assignConfidenceLevel", "synthesizeResearch", "generateStackDocument", "generateFeaturesDocument", "generateArchitectureDocument", "generatePitfallsDocument", "generateSummaryDocument"]
      min_lines: 150
    - path: "gsd/scripts/integration-test.js"
      provides: "Test Suite 10: Approval gates and research synthesis"
      contains: "Test Suite 10"
  key_links:
    - from: "gsd/scripts/research-synthesizer.js"
      to: "gsd/scripts/template-renderer.js"
      via: "import renderTemplate"
      pattern: "import.*from.*template-renderer"
    - from: "gsd/scripts/research-synthesizer.js"
      to: "gsd/templates/*.md"
      via: "readFile to load templates"
      pattern: "path\\.join.*templates.*\\.md"
    - from: "gsd/scripts/integration-test.js"
      to: "gsd/scripts/approval-gate.js"
      via: "import and test prepareApprovalGate, logApprovalDecision"
      pattern: "approval-gate"
    - from: "gsd/scripts/integration-test.js"
      to: "gsd/scripts/research-synthesizer.js"
      via: "import and test assignConfidenceLevel, synthesizeResearch"
      pattern: "research-synthesizer"
---

<objective>
Create research synthesizer with confidence scoring and generate helper functions for each research document type, then validate all Phase 4 functionality with integration tests.

Purpose: Enable automated research synthesis with multi-source confidence levels and structured document generation, completing the Advanced Features phase.

Output: research-synthesizer.js with 7 exported functions and Test Suite 10 covering approval gates and research synthesis.
</objective>

<execution_context>
@C:\Users\acous\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\acous\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@C:\Projects\GSDForTabnine\.planning\PROJECT.md
@C:\Projects\GSDForTabnine\.planning\ROADMAP.md
@C:\Projects\GSDForTabnine\.planning\STATE.md
@C:\Projects\GSDForTabnine\.planning\phases\04-advanced-features\04-RESEARCH.md
@C:\Projects\GSDForTabnine\.planning\phases\04-advanced-features\04-01-SUMMARY.md
@C:\Projects\GSDForTabnine\.planning\phases\02-core-infrastructure\02-04-SUMMARY.md
@C:\Projects\GSDForTabnine\.planning\phases\02-core-infrastructure\02-05-SUMMARY.md
@C:\Projects\GSDForTabnine\gsd\scripts\template-renderer.js
@C:\Projects\GSDForTabnine\gsd\scripts\file-ops.js
@C:\Projects\GSDForTabnine\gsd\scripts\integration-test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create research-synthesizer.js with confidence scoring and document generation</name>
  <files>gsd/scripts/research-synthesizer.js</files>
  <action>
Create research-synthesizer.js following RESEARCH.md Pattern 3 (Research Document Generation) and Pattern 4 (Confidence Level Assignment).

The script must export 7 functions:

**1. assignConfidenceLevel(finding)**
- Parameters: finding (object with {content, source, title, verifiedWithOfficial?})
- Returns: string ('HIGH', 'MEDIUM', or 'LOW')
- Logic follows RESEARCH.md Pattern 4 decision tree:
  - HIGH: source.includes('docs.') OR source.includes('official') OR source.includes('.dev') OR source matches github.com/*/docs/
  - MEDIUM: source.includes('mdn.mozilla.org') OR source.includes('stackoverflow.com') OR finding.verifiedWithOfficial === true
  - LOW: everything else (blog posts, unverified community content)
- Case-insensitive matching (use source.toLowerCase())

**2. synthesizeResearch(projectRoot, topic, findings, templateType)**
- Parameters: projectRoot (string), topic (string), findings (array of finding objects), templateType ('STACK', 'FEATURES', etc.)
- Enriches findings by calling assignConfidenceLevel() for each
- Groups findings by confidence level (high/medium/low arrays)
- Loads template from gsd/templates/${templateType}.md using readFile from file-ops.js
- Prepares rendering context: {topic, timestamp (YYYY-MM-DD), highFindings, mediumFindings, lowFindings, totalSources, sourceList}
- Renders template using renderTemplate from template-renderer.js
- Returns: string (generated markdown content)
- Async function using await for file operations

**3. generateStackDocument(projectRoot, stackFindings)**
- Parameters: projectRoot (string), stackFindings (array of technology findings)
- Calls synthesizeResearch(projectRoot, 'Technology Stack', stackFindings, 'STACK')
- Writes output to .planning/STACK.md using writeFileAtomic from file-ops.js
- Returns: string (output file path)
- Async function

**4. generateFeaturesDocument(projectRoot, featureFindings)**
- Parameters: projectRoot (string), featureFindings (array of feature findings)
- Calls synthesizeResearch(projectRoot, 'Feature Requirements', featureFindings, 'FEATURES')
- Writes output to .planning/FEATURES.md
- Returns: string (output file path)
- Async function

**5. generateArchitectureDocument(projectRoot, architectureFindings)**
- Parameters: projectRoot (string), architectureFindings (array of architecture findings)
- Calls synthesizeResearch(projectRoot, 'Architecture Patterns', architectureFindings, 'ARCHITECTURE')
- Writes output to .planning/ARCHITECTURE.md
- Returns: string (output file path)
- Async function

**6. generatePitfallsDocument(projectRoot, pitfallFindings)**
- Parameters: projectRoot (string), pitfallFindings (array of pitfall findings)
- Calls synthesizeResearch(projectRoot, 'Common Pitfalls', pitfallFindings, 'PITFALLS')
- Writes output to .planning/PITFALLS.md
- Returns: string (output file path)
- Async function

**7. generateSummaryDocument(projectRoot, allFindings)**
- Parameters: projectRoot (string), allFindings (object with {stack, features, architecture, pitfalls} arrays)
- Aggregates findings from all research types
- Calls synthesizeResearch(projectRoot, 'Research Summary', aggregated, 'SUMMARY')
- Writes output to .planning/RESEARCH-SUMMARY.md
- Returns: string (output file path)
- Async function

**Implementation details:**
- Import { readFile, writeFileAtomic } from './file-ops.js'
- Import { renderTemplate } from './template-renderer.js'
- Import path from 'node:path'
- All file operations async/await (Phase 2 convention)
- Date format: new Date().toISOString().split('T')[0] (YYYY-MM-DD)
- Source list format: findings.map(f => `- [${f.title || 'Source'}](${f.source})`).join('\n')
- Error handling: throw descriptive errors if template missing or malformed

Follow RESEARCH.md Anti-Patterns to Avoid:
- Do NOT use synchronous file operations (fs.readFileSync)
- Do NOT present LOW confidence findings as authoritative (mark with warning)
- Do NOT generate research documents without source citations
  </action>
  <verify>
Check file exists and exports:
- ls gsd/scripts/research-synthesizer.js
- grep "export function assignConfidenceLevel" gsd/scripts/research-synthesizer.js
- grep "export function synthesizeResearch" gsd/scripts/research-synthesizer.js
- grep "export function generateStackDocument" gsd/scripts/research-synthesizer.js
- grep "export function generateFeaturesDocument" gsd/scripts/research-synthesizer.js
- grep "export function generateArchitectureDocument" gsd/scripts/research-synthesizer.js
- grep "export function generatePitfallsDocument" gsd/scripts/research-synthesizer.js
- grep "export function generateSummaryDocument" gsd/scripts/research-synthesizer.js

Verify imports:
- grep "import.*file-ops" gsd/scripts/research-synthesizer.js
- grep "import.*template-renderer" gsd/scripts/research-synthesizer.js

Verify async patterns:
- grep "async function" gsd/scripts/research-synthesizer.js (should find 6 async functions)
- grep "await" gsd/scripts/research-synthesizer.js (should use await for file/template ops)

Verify no synchronous operations:
- grep "Sync" gsd/scripts/research-synthesizer.js (should find nothing)
  </verify>
  <done>
research-synthesizer.js exists with 7 exported functions (assignConfidenceLevel, synthesizeResearch, generateStackDocument, generateFeaturesDocument, generateArchitectureDocument, generatePitfallsDocument, generateSummaryDocument). Script uses existing template-renderer.js and file-ops.js, follows async/await patterns, and implements confidence level decision tree from RESEARCH.md.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Test Suite 10 for approval gates and research synthesis</name>
  <files>gsd/scripts/integration-test.js</files>
  <action>
Add Test Suite 10 to integration-test.js following the pattern from existing Test Suites 1-9.

Test Suite 10 must include 8 tests:

**Approval Gate Tests (4 tests):**

1. **Test: prepareApprovalGate formats options correctly**
   - Import { prepareApprovalGate } from './approval-gate.js'
   - Call prepareApprovalGate('Test Gate', [{name: 'Option A', pros: ['Pro 1'], cons: ['Con 1']}])
   - Assert result.gate === 'Test Gate'
   - Assert result.options.length === 1
   - Assert result.status === 'presented'
   - Assert result.timestamp is ISO string

2. **Test: logApprovalDecision appends to STATE.md**
   - Create temp directory with test STATE.md containing Key Decisions table
   - Call logApprovalDecision(tempDir, 'Stack Choice', 'React', 'User preference')
   - Read updated STATE.md
   - Assert contains "[APPROVAL GATE] Stack Choice: React"
   - Assert contains date and "User preference"
   - Cleanup temp directory

3. **Test: logApprovalDecision handles missing STATE.md**
   - Create temp directory without STATE.md
   - Call logApprovalDecision(tempDir, 'Test', 'Option', 'Reason')
   - Assert throws error mentioning missing STATE.md
   - Cleanup temp directory

4. **Test: logApprovalDecision preserves existing decisions**
   - Create temp STATE.md with 2 existing decisions
   - Call logApprovalDecision to add 3rd decision
   - Read updated STATE.md
   - Assert all 3 decisions present
   - Assert order preserved
   - Cleanup temp directory

**Research Synthesis Tests (4 tests):**

5. **Test: assignConfidenceLevel detects HIGH confidence sources**
   - Import { assignConfidenceLevel } from './research-synthesizer.js'
   - Test official docs: {source: 'https://docs.example.com/guide'} → 'HIGH'
   - Test .dev domain: {source: 'https://example.dev/docs'} → 'HIGH'
   - Test GitHub docs: {source: 'https://github.com/owner/repo/blob/main/docs/guide.md'} → 'HIGH'

6. **Test: assignConfidenceLevel detects MEDIUM confidence sources**
   - Test MDN: {source: 'https://developer.mozilla.org/en-US/docs/Web'} → 'MEDIUM'
   - Test Stack Overflow: {source: 'https://stackoverflow.com/questions/123'} → 'MEDIUM'
   - Test verified finding: {source: 'https://blog.example.com', verifiedWithOfficial: true} → 'MEDIUM'

7. **Test: assignConfidenceLevel detects LOW confidence sources**
   - Test blog: {source: 'https://blog.example.com/post'} → 'LOW'
   - Test unverified: {source: 'https://random-site.com'} → 'LOW'

8. **Test: synthesizeResearch generates document with confidence sections**
   - Create temp directory with STACK.md template
   - Create test findings: [{title: 'Test', content: 'Content', source: 'https://docs.example.com'}]
   - Call synthesizeResearch(tempDir, 'Test Stack', findings, 'STACK')
   - Assert result contains "## High Confidence Findings"
   - Assert result contains "https://docs.example.com"
   - Cleanup temp directory

**Test execution pattern:**
- Follow existing test suite structure (console group, individual tests with try/catch)
- Accumulate failures in testResults array
- Report pass/fail counts at end
- Use fs.mkdirSync(path, {recursive: true}) for temp directories
- Use fs.rmSync(path, {recursive: true, force: true}) for cleanup
- Import fs from 'node:fs' (already imported in integration-test.js)

**Update test summary:**
- Increment total test count (43 existing + 8 new = 51 total)
- Add Test Suite 10 to summary output
- Update success rate calculation
  </action>
  <verify>
Run integration tests:
- node gsd/scripts/integration-test.js

Expected output:
- "Test Suite 10: Approval Gates and Research Synthesis" appears
- 8 new tests listed
- Total tests: 51 (43 existing + 8 new)
- All tests pass (51/51)

Check test additions:
- grep "Test Suite 10" gsd/scripts/integration-test.js
- grep "prepareApprovalGate formats options correctly" gsd/scripts/integration-test.js
- grep "assignConfidenceLevel detects HIGH confidence" gsd/scripts/integration-test.js
  </verify>
  <done>
integration-test.js includes Test Suite 10 with 8 tests covering approval gate functionality (prepareApprovalGate, logApprovalDecision) and research synthesis (assignConfidenceLevel, synthesizeResearch). All 51 integration tests pass (43 existing + 8 new). Test suite validates Phase 4 functionality end-to-end.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **Research synthesizer validation:**
   - research-synthesizer.js exports 7 functions
   - Confidence level assignment follows RESEARCH.md decision tree
   - Document generation uses existing template-renderer.js
   - All functions are async with await for file operations

2. **Integration test validation:**
   - Test Suite 10 exists with 8 tests
   - Approval gate tests cover formatting, logging, error handling, preservation
   - Research synthesis tests cover HIGH/MEDIUM/LOW confidence detection and document generation
   - All 51 tests pass (100% pass rate)

3. **End-to-end validation:**
   - Approval gates can present options and log decisions to STATE.md
   - Research synthesizer can assign confidence levels and generate documents
   - Generated documents include confidence sections and source citations
   - All functionality tested and verified

Run verification commands:
```bash
# Research synthesizer exports
grep "export function" gsd/scripts/research-synthesizer.js | wc -l
# Should output: 7

# Integration tests
node gsd/scripts/integration-test.js
# Should show: 51/51 tests passed (100%)

# Test coverage
grep "Test Suite 10" gsd/scripts/integration-test.js
```
</verification>

<success_criteria>
1. research-synthesizer.js exists with 7 exported functions (assignConfidenceLevel, synthesizeResearch, generate*Document)
2. Confidence level assignment follows RESEARCH.md Pattern 4 decision tree (HIGH/MEDIUM/LOW)
3. Document generation uses existing template-renderer.js and file-ops.js (Phase 2 infrastructure)
4. Integration tests include Test Suite 10 with 8 new tests (approval gates + research synthesis)
5. All 51 integration tests pass (43 existing + 8 new = 100% pass rate)
6. Research documents include confidence sections and source URLs (RES-05 requirement)
7. All file operations use async/await patterns (Phase 2 convention)
8. Phase 4 requirements HITL-01 through HITL-05 and RES-01 through RES-05 fulfilled
</success_criteria>

<output>
After completion, create `.planning/phases/04-advanced-features/04-02-SUMMARY.md` with:
- Files created (research-synthesizer.js) and modified (integration-test.js)
- Exports from research-synthesizer.js (7 functions)
- Test results (51/51 tests passed)
- Requirements fulfilled: All Phase 4 requirements (HITL-01 through HITL-05, RES-01 through RES-05)
- Phase 4 complete: Advanced Features delivered
- Integration points: How to use approval gates and research synthesis in workflows
- Next phase: None (Phase 4 is final phase in roadmap)
</output>
