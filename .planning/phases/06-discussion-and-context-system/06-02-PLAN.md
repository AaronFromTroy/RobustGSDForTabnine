---
phase: 06-discussion-and-context-system
plan: 02
type: execute
wave: 2
depends_on: [06-01]
files_modified: [gsd/scripts/context-loader.js, gsd/guidelines/plan-phase.md]
autonomous: true

must_haves:
  truths:
    - "Planning scripts can read CONTEXT.md and extract locked decisions"
    - "plan-phase.md workflow includes saving discussion to CONTEXT.md"
    - "Locked decisions in CONTEXT.md are treated as constraints by planning"
  artifacts:
    - path: "gsd/scripts/context-loader.js"
      provides: "CONTEXT.md parsing and decision extraction"
      exports: ["loadPhaseContext", "parseDecisions", "categorizeAnswers", "saveDiscussionContext"]
      min_lines: 120
    - path: "gsd/guidelines/plan-phase.md"
      provides: "Updated workflow with CONTEXT.md persistence"
      contains: "saveDiscussionContext"
      modified: true
  key_links:
    - from: "gsd/scripts/context-loader.js"
      to: "CONTEXT.md files"
      via: "Reads and writes structured context"
      pattern: "loadPhaseContext.*CONTEXT\\.md"
    - from: "gsd/guidelines/plan-phase.md"
      to: "gsd/scripts/context-loader.js"
      via: "Guideline instructs context persistence"
      pattern: "context-loader\\.js.*saveDiscussionContext"
---

<objective>
Create context loader for CONTEXT.md parsing and integrate discussion workflow with plan-phase.md.

**Purpose:** Enable research and planning scripts to read user decisions from CONTEXT.md, ensuring locked choices are respected. Update plan-phase.md to persist discussion results in structured format.

**Output:** context-loader.js for parsing CONTEXT.md and updated plan-phase.md guideline that saves discussion to CONTEXT.md before creating plans.
</objective>

<execution_context>
@gsd/guidelines/execute-phase.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-discussion-and-context-system/06-RESEARCH.md
@.planning/phases/06-discussion-and-context-system/06-01-SUMMARY.md

# Integration patterns
@gsd/scripts/state-manager.js
@gsd/scripts/template-renderer.js
@gsd/templates/CONTEXT.md
@gsd/scripts/question-bank.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create context-loader.js for CONTEXT.md parsing</name>
  <files>gsd/scripts/context-loader.js</files>
  <action>
Create gsd/scripts/context-loader.js following patterns from existing scripts:

**Import dependencies:**
```javascript
import matter from 'gray-matter';
import fs from 'fs';
import path from 'path';
import { renderTemplate } from './template-renderer.js';
import { writeFileAtomic } from './file-ops.js';
```

**Export 4 functions:**

1. **loadPhaseContext(phase, phaseName)**: Loads and parses CONTEXT.md if exists
   - Construct path: `.planning/phases/${phase}-${phaseName}/${phase}-CONTEXT.md`
   - Return null if file doesn't exist (no context = full discretion)
   - Use gray-matter to parse frontmatter and content
   - Extract `<decisions>` section with regex: `/<decisions>([\s\S]*?)<\/decisions>/`
   - Extract `<deferred>` section similarly
   - Parse decisions markdown into object (bullet format: `- **Key:** Value`)
   - Extract "Claude's Discretion" subsection from decisions
   - Return: `{ frontmatter, decisions, discretion, deferred }`

2. **parseDecisions(markdown)**: Parses decision markdown into key-value object
   - Regex: `/- \*\*([^:]+):\*\* (.+)/g`
   - Convert keys to lowercase snake_case: `"Technology Stack" → "technology_stack"`
   - Return object mapping keys to values

3. **categorizeAnswers(answers)**: Categorizes user responses
   - Locked: User explicitly chose something (not "skip", "up to you", empty)
   - Discretion: User said "skip", "up to you", or left blank
   - Deferred: User said "not now", "later", "future phase"
   - Return: `{ locked, discretion, deferred }` arrays/objects

4. **saveDiscussionContext(phase, phaseName, answers, phaseGoal)**: Saves to CONTEXT.md
   - Create phase directory if needed: `.planning/phases/${phase}-${phaseName}`
   - Categorize answers using categorizeAnswers()
   - Prepare template variables:
     - phase: number
     - phase_name: string
     - gathered: ISO date (YYYY-MM-DD)
     - status: "ready-for-planning"
     - discussion_type: answers.phaseType || "technical"
     - phase_boundary: phaseGoal (from ROADMAP.md)
     - locked_decisions: formatted markdown bullets
     - discretion_items: formatted markdown bullets
     - deferred_items: formatted markdown bullets
   - Render CONTEXT template using template-renderer.js
   - Write atomically using file-ops.js writeFileAtomic
   - Return path to created file

**Implementation notes:**
- Follow ESM patterns (import/export)
- Use async/await for file operations
- Handle missing files gracefully (loadPhaseContext returns null)
- Use existing utilities (template-renderer.js, file-ops.js, gray-matter)
- Add JSDoc comments for all functions
- Follow error handling patterns from state-manager.js
  </action>
  <verify>
1. File exists: gsd/scripts/context-loader.js
2. Exports all 4 functions: loadPhaseContext, parseDecisions, categorizeAnswers, saveDiscussionContext
3. Uses gray-matter for frontmatter parsing (existing dependency)
4. Uses template-renderer.js for CONTEXT.md generation
5. Uses writeFileAtomic for safe file writes
6. ESM syntax throughout
7. Test manually:
   ```javascript
   import { parseDecisions } from './gsd/scripts/context-loader.js';
   const markdown = '- **Library:** React\n- **Testing:** Jest';
   console.log(parseDecisions(markdown));
   // Expected: { library: 'React', testing: 'Jest' }
   ```
8. Handles missing CONTEXT.md gracefully (returns null, doesn't throw)
  </verify>
  <done>context-loader.js provides full CONTEXT.md read/write capability</done>
</task>

<task type="auto">
  <name>Task 2: Update plan-phase.md with CONTEXT.md persistence</name>
  <files>gsd/guidelines/plan-phase.md</files>
  <action>
Update gsd/guidelines/plan-phase.md to integrate CONTEXT.md workflow:

**Changes to make:**

1. **In "Workflow Steps > Phase 2: Pre-Planning Discussion" section:**
   - After showing questions to user and getting responses, add step to save context:
   ```
   4. **Save discussion context:**
      After user provides responses, persist to CONTEXT.md:

      ```bash
      node gsd/scripts/context-loader.js \
        --action=save \
        --phase=${PHASE_NUM} \
        --phaseName="${PHASE_NAME}" \
        --answers='${USER_ANSWERS_JSON}' \
        --phaseGoal="${PHASE_GOAL}"
      ```

      This creates: `.planning/phases/XX-name/XX-CONTEXT.md`
   ```

2. **In "Commands" section:**
   - Add new command after "Pre-Planning Discussion":
   ```markdown
   ### Save Discussion Context
   ```bash
   # Persist user responses to CONTEXT.md
   node gsd/scripts/context-loader.js \
     --action=save \
     --phase=${PHASE_NUM} \
     --phaseName="${PHASE_NAME}" \
     --answers='${ANSWERS_JSON}' \
     --phaseGoal="${GOAL_FROM_ROADMAP}"
   ```
   ```

3. **In "Project Structure" section:**
   - Update to show CONTEXT.md:
   ```
   .planning/
   └── phases/
       └── XX-name/
           ├── XX-CONTEXT.md           # Discussion results (NEW)
           ├── XX-RESEARCH.md          # Optional research
           ├── XX-01-PLAN.md           # First plan
           └── XX-02-PLAN.md           # Second plan
   ```

4. **In "Boundaries > Always Do" section:**
   - Add bullet: "Save discussion responses to CONTEXT.md before creating plans"

5. **In "Success Criteria" section:**
   - Update item 1 to: "Discussion phase completed and saved to CONTEXT.md: User answered clarifying questions or explicitly skipped"

**Notes:**
- Keep existing discussion questions (v1.1.0 comprehensive questions)
- Reference question-bank.js for adaptive questioning
- Preserve all existing workflow steps (don't remove anything)
- CONTEXT.md is created AFTER discussion, BEFORE plan creation
- Planning consumes CONTEXT.md to respect locked decisions
  </action>
  <verify>
1. plan-phase.md contains reference to context-loader.js saveDiscussionContext
2. "Workflow Steps > Phase 2" includes step to save CONTEXT.md
3. "Project Structure" section shows XX-CONTEXT.md
4. "Commands" section includes context saving command
5. "Boundaries > Always Do" includes CONTEXT.md persistence
6. "Success Criteria" updated to require CONTEXT.md
7. Existing discussion questions preserved (v1.1.0 content intact)
8. File still valid markdown (check with markdownlint if available)
  </verify>
  <done>plan-phase.md workflow now persists discussion to CONTEXT.md before planning</done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **Context loader validation:**
   - loadPhaseContext can parse existing CONTEXT.md files
   - parseDecisions extracts key-value pairs from markdown
   - categorizeAnswers correctly splits locked/discretion/deferred
   - saveDiscussionContext creates valid CONTEXT.md files

2. **Workflow integration validation:**
   - plan-phase.md includes CONTEXT.md save step before plan creation
   - Project structure documentation updated
   - Success criteria require CONTEXT.md

3. **End-to-end flow:**
   - Discussion → Save to CONTEXT.md → Load in planning → Respect decisions
   - CONTEXT.md files are machine-readable (can be parsed by scripts)
   - Manual editing of CONTEXT.md still supported (human-readable markdown)

4. **Manual test:**
   ```bash
   # Test parsing
   node -e "import('./gsd/scripts/context-loader.js').then(m => console.log(m.parseDecisions('- **Test:** Value')))"
   # Expected: { test: 'Value' }
   ```
</verification>

<success_criteria>
1. gsd/scripts/context-loader.js exports all 4 functions (load, parse, categorize, save)
2. loadPhaseContext returns null for missing files (graceful handling)
3. parseDecisions extracts key-value pairs from bullet markdown
4. saveDiscussionContext creates valid CONTEXT.md using template
5. plan-phase.md workflow includes CONTEXT.md save step after discussion
6. plan-phase.md updated sections: Commands, Workflow Steps, Project Structure, Boundaries, Success Criteria
7. Integration points documented for research/planning consumption
</success_criteria>

<output>
After completion, create `.planning/phases/06-discussion-and-context-system/06-02-SUMMARY.md` documenting:
- context-loader.js functions and usage
- plan-phase.md changes (which sections updated)
- CONTEXT.md save/load workflow
- Integration readiness for research/planning
- Any deviations from plan
</output>
