---
phase: 06-discussion-and-context-system
plan: 03
type: execute
wave: 3
depends_on: [06-01, 06-02]
files_modified: [gsd/scripts/integration-test.js]
autonomous: true

must_haves:
  truths:
    - "Test suite validates CONTEXT.md template rendering"
    - "Test suite validates question taxonomy phase type detection"
    - "Test suite validates context parsing (load, parse, categorize)"
    - "All 57+ existing tests still pass (no regressions)"
  artifacts:
    - path: "gsd/scripts/integration-test.js"
      provides: "Test Suite 12 for discussion system"
      contains: "Test Suite 12: Discussion & Context System"
      modified: true
  key_links:
    - from: "Test Suite 12"
      to: "gsd/scripts/question-bank.js"
      via: "Tests phase type detection and question selection"
      pattern: "detectPhaseType.*getQuestionsForPhase"
    - from: "Test Suite 12"
      to: "gsd/scripts/context-loader.js"
      via: "Tests context parsing and categorization"
      pattern: "loadPhaseContext.*parseDecisions.*categorizeAnswers"
---

<objective>
Add comprehensive test coverage for discussion and context system.

**Purpose:** Validate that CONTEXT.md template rendering, question taxonomy, and context parsing work correctly. Ensure no regressions in existing functionality.

**Output:** Test Suite 12 with 8+ tests covering all Phase 6 modules, all tests passing (100% pass rate).
</objective>

<execution_context>
@gsd/guidelines/execute-phase.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-discussion-and-context-system/06-RESEARCH.md
@.planning/phases/06-discussion-and-context-system/06-01-SUMMARY.md
@.planning/phases/06-discussion-and-context-system/06-02-SUMMARY.md

# Testing patterns
@gsd/scripts/integration-test.js
@.planning/phases/02-core-infrastructure/02-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Test Suite 12 for discussion system</name>
  <files>gsd/scripts/integration-test.js</files>
  <action>
Add Test Suite 12 to gsd/scripts/integration-test.js following existing patterns:

**Test suite structure:**
```javascript
console.log('\n=== Test Suite 12: Discussion & Context System ===');

// Test 1: CONTEXT.md template rendering
{
  const result = await renderTemplate('CONTEXT', {
    phase: 6,
    phase_name: 'discussion-and-context-system',
    gathered: '2026-01-20',
    status: 'ready-for-planning',
    discussion_type: 'technical',
    phase_boundary: 'Gather user context before planning',
    locked_decisions: '- **Library:** React\n- **Testing:** Jest',
    discretion_items: '- Component structure\n- File naming',
    deferred_items: '- Advanced features\n- Performance optimization'
  });

  assert(result.includes('phase: 6'), 'CONTEXT template renders frontmatter');
  assert(result.includes('<decisions>'), 'CONTEXT template has decisions section');
  assert(result.includes('<deferred>'), 'CONTEXT template has deferred section');
  passedTests++;
}

// Test 2: Phase type detection - UI phase
{
  const phaseType = detectPhaseType('Build dashboard UI with responsive design');
  assert(phaseType.technical === true, 'UI phase detected as technical');
  assert(phaseType.design === true, 'UI phase detected as design');
  assert(phaseType.workflow === true, 'UI phase includes workflow questions');
  passedTests++;
}

// Test 3: Phase type detection - API phase
{
  const phaseType = detectPhaseType('Create REST API infrastructure');
  assert(phaseType.technical === true, 'API phase detected as technical');
  assert(phaseType.design === false, 'API phase not design-focused');
  assert(phaseType.workflow === true, 'API phase includes workflow questions');
  passedTests++;
}

// Test 4: Get questions for phase
{
  const questions = getQuestionsForPhase('Dashboard UI');
  assert(Array.isArray(questions), 'Questions returned as array');
  assert(questions.length > 0, 'Questions array not empty');
  assert(questions.some(q => q.category === 'design'), 'Design questions included for UI phase');
  passedTests++;
}

// Test 5: Parse decisions from markdown
{
  const markdown = '- **Library:** React\n- **Testing Strategy:** Jest with React Testing Library';
  const decisions = parseDecisions(markdown);
  assert(decisions.library === 'React', 'Library decision parsed');
  assert(decisions.testing_strategy === 'Jest with React Testing Library', 'Testing strategy parsed with snake_case key');
  passedTests++;
}

// Test 6: Categorize answers - locked
{
  const answers = {
    library: 'React',
    testing: 'Jest',
    styling: 'skip',
    performance: 'not now'
  };
  const { locked, discretion, deferred } = categorizeAnswers(answers);
  assert(locked.some(d => d.answer === 'React'), 'React categorized as locked');
  assert(locked.some(d => d.answer === 'Jest'), 'Jest categorized as locked');
  passedTests++;
}

// Test 7: Categorize answers - discretion
{
  const answers = {
    naming: 'up to you',
    structure: '',
    pattern: 'skip'
  };
  const { locked, discretion, deferred } = categorizeAnswers(answers);
  assert(discretion.includes('naming') || discretion.some(d => d === 'naming'), 'up to you categorized as discretion');
  assert(discretion.includes('pattern') || discretion.some(d => d === 'pattern'), 'skip categorized as discretion');
  passedTests++;
}

// Test 8: Categorize answers - deferred
{
  const answers = {
    advanced: 'not now',
    optimization: 'later'
  };
  const { locked, discretion, deferred } = categorizeAnswers(answers);
  assert(deferred.some(d => d.question === 'advanced' || d.answer?.includes('not now')), 'not now categorized as deferred');
  assert(deferred.some(d => d.question === 'optimization' || d.answer?.includes('later')), 'later categorized as deferred');
  passedTests++;
}

// Test 9: Load missing CONTEXT.md (graceful handling)
{
  const context = loadPhaseContext(99, 'nonexistent-phase');
  assert(context === null, 'Returns null for missing CONTEXT.md');
  passedTests++;
}
```

**Import statements to add:**
```javascript
import { detectPhaseType, getQuestionsForPhase } from './question-bank.js';
import { parseDecisions, categorizeAnswers, loadPhaseContext } from './context-loader.js';
```

**Update totalTests count:**
- Current: 57 tests
- Add: 9 tests (Test Suite 12)
- New total: 66 tests

**Follow patterns from existing test suites:**
- Use try/catch with error accumulation
- Increment totalTests at suite start
- Increment passedTests on assertion success
- Add to failedTests array on assertion failure
- Clean formatting with test descriptions
  </action>
  <verify>
1. integration-test.js contains "Test Suite 12: Discussion & Context System"
2. Test Suite 12 has 9 tests (template rendering, phase detection, questions, parsing, categorization, loading)
3. Imports question-bank.js and context-loader.js at top of file
4. totalTests updated to 66 (57 existing + 9 new)
5. All existing tests still pass (no regressions)
6. Run full test suite:
   ```bash
   npm test
   ```
   Expected: "66/66 tests passed (100%)"
7. Tests validate core functionality:
   - CONTEXT template rendering
   - Phase type detection (UI, API)
   - Question selection adapts to phase
   - Decision parsing from markdown
   - Answer categorization (locked/discretion/deferred)
   - Graceful handling of missing files
  </verify>
  <done>Test Suite 12 validates all Phase 6 discussion system functionality with 100% pass rate</done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **Test coverage validation:**
   - All 3 Phase 6 modules tested (CONTEXT template, question-bank.js, context-loader.js)
   - Template rendering tested
   - Phase type detection tested (UI and API scenarios)
   - Question selection tested
   - Decision parsing tested
   - Answer categorization tested (all 3 categories)
   - Error handling tested (missing files)

2. **Integration test validation:**
   - Run: `npm test` (or `node gsd/scripts/integration-test.js`)
   - Expected: 66/66 tests passed (100%)
   - No failures in existing Test Suites 1-11
   - Test Suite 12 all green

3. **Regression check:**
   - All 57 existing tests still pass
   - No broken imports
   - No changed behavior in existing modules

4. **Manual verification:**
   ```bash
   npm test
   # Check output for:
   # - "Test Suite 12: Discussion & Context System"
   # - "66/66 tests passed"
   # - No "FAILED" messages
   ```
</verification>

<success_criteria>
1. Test Suite 12 added to integration-test.js with 9 tests
2. Tests cover: template rendering, phase detection, question selection, parsing, categorization, error handling
3. All 66 tests pass (57 existing + 9 new = 100% pass rate)
4. No regressions in existing test suites (1-11)
5. Imports for question-bank.js and context-loader.js added
6. totalTests count updated to 66
7. Test output shows clear pass/fail for each test
8. npm test command runs successfully
</success_criteria>

<output>
After completion, create `.planning/phases/06-discussion-and-context-system/06-03-SUMMARY.md` documenting:
- Test Suite 12 structure (9 tests)
- Test coverage (which modules tested, what scenarios)
- Test results (66/66 passed, 100% pass rate)
- Any test failures encountered and how resolved
- Any deviations from plan
</output>
