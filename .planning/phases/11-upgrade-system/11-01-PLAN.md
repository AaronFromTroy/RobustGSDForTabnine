---
phase: 11-upgrade-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - gsd/package.json
  - gsd/scripts/version-checker.js
autonomous: true

must_haves:
  truths:
    - System can detect current GSD version from package.json
    - System can query npm registry for latest available version
    - System can detect version from local upgrade sources
    - System compares versions using semver (handles ranges, pre-release)
    - System displays update notification when newer version available
    - Notification respects user preferences (can opt-out)
  artifacts:
    - path: gsd/scripts/version-checker.js
      provides: Version detection and comparison
      exports: [checkForUpdates, getCurrentVersion, getLatestVersion, checkNpmAvailability, isValidGsdSource]
      min_lines: 120
    - path: gsd/package.json
      provides: Updated dependencies
      contains: semver
  key_links:
    - from: gsd/scripts/version-checker.js
      to: npm registry API
      via: fetch request
      pattern: 'registry\.npmjs\.org'
    - from: gsd/scripts/version-checker.js
      to: package.json
      via: readFileSync
      pattern: 'readFileSync.*package\.json'
---

<objective>
Implement version detection and update notification system to inform users when GSD upgrades are available.

Purpose: Enable users to stay current with latest GSD features and bug fixes without manual checking. Foundation for automated upgrade system.

Output: Version checker module with npm registry integration and update notification capability.
</objective>

<execution_context>
@C:\Projects\GSDForTabnine\.claude\get-shit-done\workflows\execute-plan.md
@C:\Projects\GSDForTabnine\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@C:\Projects\GSDForTabnine\.planning\PROJECT.md
@C:\Projects\GSDForTabnine\.planning\ROADMAP.md
@C:\Projects\GSDForTabnine\.planning\STATE.md
@C:\Projects\GSDForTabnine\.planning\phases\11-upgrade-system\11-RESEARCH.md

# Existing infrastructure
@C:\Projects\GSDForTabnine\gsd\package.json
@C:\Projects\GSDForTabnine\gsd\scripts\file-ops.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install version management dependencies</name>
  <files>gsd/package.json, gsd/package-lock.json</files>
  <action>
Install semver and update-notifier packages for version management.

Run from gsd/ directory:
```bash
cd "C:\Projects\GSDForTabnine\gsd"
npm install semver@^7.6.0 update-notifier@^7.3.1
```

These packages provide:
- semver: Official semantic versioning library (100M+ weekly downloads)
- update-notifier: Background update checking with caching (industry standard for CLI tools)

Verify dependencies added to package.json and package-lock.json updated.
  </action>
  <verify>
```bash
cd "C:\Projects\GSDForTabnine\gsd"
node -e "import('semver').then(() => console.log('semver OK'))"
node -e "import('update-notifier').then(() => console.log('update-notifier OK'))"
grep -E "semver|update-notifier" package.json
```
  </verify>
  <done>Dependencies installed, imports work, package.json contains both packages</done>
</task>

<task type="auto">
  <name>Task 2: Create version-checker.js module</name>
  <files>gsd/scripts/version-checker.js</files>
  <action>
Create gsd/scripts/version-checker.js with five exported functions for dual-mode version management.

Implementation requirements:

**Function 1: getCurrentVersion()**
- Reads gsd/package.json from file system
- Returns current version string (e.g., "1.0.0")
- Uses file-ops.js readFile for consistency
- Handles missing file gracefully (return null)

**Function 2: getLatestVersion(options = {})**
- Options: { source = 'npm', localPath = null, packageName = 'gsd-for-tabnine' }
- **npm mode:**
  - Queries npm registry API: https://registry.npmjs.org/${packageName}
  - Extracts latest version from data['dist-tags'].latest
  - Returns version string or null on error
  - Includes timeout (3 seconds) to prevent hanging
  - Network error = return null (don't crash, just skip update check)
- **local mode:**
  - Reads package.json from localPath
  - Returns version string from pkg.version
  - Validates file exists and is valid JSON
  - Returns null if invalid

**Function 3: checkForUpdates(options = {})**
- Calls getCurrentVersion() and getLatestVersion(options)
- Uses semver.gt() to compare versions
- Uses semver.diff() to determine update type (major/minor/patch)
- Returns object: { hasUpdate: boolean, current: string, latest: string, type: string, source: string }
- If no update: { hasUpdate: false, current: version, source }
- Gracefully handles network failures (returns hasUpdate: false)

**Function 4: checkNpmAvailability()**
- Quick network check: can we reach npm registry?
- Uses fetch with 3-second timeout and AbortController
- HEAD request (no download, just connectivity check)
- Returns: { available: boolean, reason: string | null }
- Catches timeout, network errors, HTTP errors
- Used by upgrade-manager for auto-detection

**Function 5: isValidGsdSource(path)**
- Validates if path contains valid GSD installation
- Checks package.json exists with name: "gsd-for-tabnine"
- Checks required directories: scripts/, templates/, guidelines/
- Returns boolean
- Used by upgrade-manager for local source detection

**Additional features:**
- ESM module syntax (import/export)
- Proper error handling with try/catch
- Clear console output formatting
- Compatible with update-notifier for future integration
- Dual-mode support (npm + local) for flexibility

**Source detection candidates (for local mode):**
- ../gsd-upgrade (convention)
- ../gsd-latest (convention)
- ../gsd-for-tabnine (GitHub clone name)
- process.env.GSD_UPGRADE_PATH (optional env var)

**DO NOT:**
- Use CommonJS (require/module.exports) - GSD uses ESM
- Prompt user directly in this module - that's upgrade-manager's job
- Auto-download updates - only detect and notify
- Hard-fail on npm unavailability - that's what local mode is for

Use RESEARCH.md code examples as reference, especially "Version Detection and Comparison" section.
  </action>
  <verify>
```bash
cd "C:\Projects\GSDForTabnine\gsd"
# Manual test - npm mode
node -e "
import('./scripts/version-checker.js').then(async (m) => {
  const current = await m.getCurrentVersion();
  console.log('Current:', current);

  // Test npm availability
  const npmCheck = await m.checkNpmAvailability();
  console.log('npm available:', npmCheck);

  const latest = await m.getLatestVersion({ source: 'npm' });
  console.log('Latest (npm):', latest);

  // Test local mode (with current dir as source)
  const isValid = await m.isValidGsdSource('.');
  console.log('Is valid GSD source:', isValid);

  const localVersion = await m.getLatestVersion({ source: 'local', localPath: '.' });
  console.log('Version (local):', localVersion);

  const check = await m.checkForUpdates();
  console.log('Update check:', check);
});
"
```

Expected: Current version from package.json, npm availability check, latest from npm (or null if unavailable), local validation works, update check result.
  </verify>
  <done>version-checker.js exports 5 functions, dual-mode support works, network errors handled gracefully, local validation works</done>
</task>

<task type="auto">
  <name>Task 3: Add module to exports and test</name>
  <files>gsd/package.json, gsd/scripts/index.js</files>
  <action>
Add version-checker to package.json exports for external access.

1. Update gsd/package.json exports field:
```json
"exports": {
  ".": "./scripts/index.js",
  "./state-manager": "./scripts/state-manager.js",
  "./template-renderer": "./scripts/template-renderer.js",
  "./guideline-loader": "./scripts/guideline-loader.js",
  "./validator": "./scripts/validator.js",
  "./researcher": "./scripts/researcher.js",
  "./research-synthesizer": "./scripts/research-synthesizer.js",
  "./version-checker": "./scripts/version-checker.js"
}
```

2. Update gsd/scripts/index.js to re-export version-checker functions:
```javascript
// Add to existing exports
export { checkForUpdates, getCurrentVersion, getLatestVersion } from './version-checker.js';
```

3. Verify exports work:
```bash
node -e "import('gsd-for-tabnine/version-checker').then(m => console.log('Export OK'))"
```
  </action>
  <verify>
```bash
cd "C:\Projects\GSDForTabnine\gsd"
# Verify subpath export
node -e "import('./scripts/version-checker.js').then(() => console.log('Direct import OK'))"

# Verify main entry re-export
node -e "import('./scripts/index.js').then((m) => {
  console.log('checkForUpdates:', typeof m.checkForUpdates);
  console.log('getCurrentVersion:', typeof m.getCurrentVersion);
  console.log('getLatestVersion:', typeof m.getLatestVersion);
})"
```

Expected: All three functions exported as "function".
  </verify>
  <done>version-checker subpath export added, main entry re-exports all 3 functions, verification passes</done>
</task>

</tasks>

<verification>
**Module exports:**
- version-checker.js exports checkForUpdates, getCurrentVersion, getLatestVersion
- Functions accessible via subpath import (gsd-for-tabnine/version-checker)
- Functions re-exported from main entry (gsd-for-tabnine)

**Version detection:**
- getCurrentVersion reads local package.json
- getLatestVersion queries npm registry
- Network failures handled gracefully (no crashes)

**Version comparison:**
- checkForUpdates uses semver.gt for comparison
- Returns update type (major/minor/patch) when update available
- Returns hasUpdate: false when current or network unavailable
</verification>

<success_criteria>
**Plan complete when:**
1. semver and update-notifier dependencies installed
2. version-checker.js exists with 5 exported functions
3. getCurrentVersion returns version from package.json
4. getLatestVersion supports both npm and local sources
5. checkNpmAvailability detects npm registry connectivity
6. isValidGsdSource validates local upgrade sources
7. checkForUpdates compares versions using semver
8. Network failures handled gracefully (no crashes)
9. Module exported via package.json and index.js
10. Manual verification shows both npm and local modes work
</success_criteria>

<output>
After completion, create `.planning/phases/11-upgrade-system/11-01-SUMMARY.md`
</output>
