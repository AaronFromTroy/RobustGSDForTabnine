---
phase: 11-upgrade-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - gsd/package.json
  - gsd/scripts/version-checker.js
autonomous: true

must_haves:
  truths:
    - System can detect current GSD version from package.json
    - System can query npm registry for latest available version
    - System compares versions using semver (handles ranges, pre-release)
    - System displays update notification when newer version available
    - Notification respects user preferences (can opt-out)
  artifacts:
    - path: gsd/scripts/version-checker.js
      provides: Version detection and comparison
      exports: [checkForUpdates, getCurrentVersion, getLatestVersion]
      min_lines: 80
    - path: gsd/package.json
      provides: Updated dependencies
      contains: semver
  key_links:
    - from: gsd/scripts/version-checker.js
      to: npm registry API
      via: fetch request
      pattern: 'registry\.npmjs\.org'
    - from: gsd/scripts/version-checker.js
      to: package.json
      via: readFileSync
      pattern: 'readFileSync.*package\.json'
---

<objective>
Implement version detection and update notification system to inform users when GSD upgrades are available.

Purpose: Enable users to stay current with latest GSD features and bug fixes without manual checking. Foundation for automated upgrade system.

Output: Version checker module with npm registry integration and update notification capability.
</objective>

<execution_context>
@C:\Projects\GSDForTabnine\.claude\get-shit-done\workflows\execute-plan.md
@C:\Projects\GSDForTabnine\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@C:\Projects\GSDForTabnine\.planning\PROJECT.md
@C:\Projects\GSDForTabnine\.planning\ROADMAP.md
@C:\Projects\GSDForTabnine\.planning\STATE.md
@C:\Projects\GSDForTabnine\.planning\phases\11-upgrade-system\11-RESEARCH.md

# Existing infrastructure
@C:\Projects\GSDForTabnine\gsd\package.json
@C:\Projects\GSDForTabnine\gsd\scripts\file-ops.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install version management dependencies</name>
  <files>gsd/package.json, gsd/package-lock.json</files>
  <action>
Install semver and update-notifier packages for version management.

Run from gsd/ directory:
```bash
cd "C:\Projects\GSDForTabnine\gsd"
npm install semver@^7.6.0 update-notifier@^7.3.1
```

These packages provide:
- semver: Official semantic versioning library (100M+ weekly downloads)
- update-notifier: Background update checking with caching (industry standard for CLI tools)

Verify dependencies added to package.json and package-lock.json updated.
  </action>
  <verify>
```bash
cd "C:\Projects\GSDForTabnine\gsd"
node -e "import('semver').then(() => console.log('semver OK'))"
node -e "import('update-notifier').then(() => console.log('update-notifier OK'))"
grep -E "semver|update-notifier" package.json
```
  </verify>
  <done>Dependencies installed, imports work, package.json contains both packages</done>
</task>

<task type="auto">
  <name>Task 2: Create version-checker.js module</name>
  <files>gsd/scripts/version-checker.js</files>
  <action>
Create gsd/scripts/version-checker.js with three exported functions for version management.

Implementation requirements:

**Function 1: getCurrentVersion()**
- Reads gsd/package.json from file system
- Returns current version string (e.g., "1.0.0")
- Uses file-ops.js readFile for consistency
- Handles missing file gracefully (return null)

**Function 2: getLatestVersion(packageName = 'gsd-for-tabnine')**
- Queries npm registry API: https://registry.npmjs.org/${packageName}
- Extracts latest version from data['dist-tags'].latest
- Uses fetch (native Node.js 18+ fetch)
- Returns version string or null on error
- Includes timeout (5 seconds) to prevent hanging
- Network error = return null (don't crash, just skip update check)

**Function 3: checkForUpdates(options = {})**
- Calls getCurrentVersion() and getLatestVersion()
- Uses semver.gt() to compare versions
- Uses semver.diff() to determine update type (major/minor/patch)
- Returns object: { hasUpdate: boolean, current: string, latest: string, type: string }
- If no update: { hasUpdate: false, current: version }
- Gracefully handles network failures (returns hasUpdate: false)

**Additional features:**
- ESM module syntax (import/export)
- Proper error handling with try/catch
- Clear console output formatting
- Compatible with update-notifier for future integration

**DO NOT:**
- Use CommonJS (require/module.exports) - GSD uses ESM
- Prompt user directly in this module - that's upgrade-manager's job
- Auto-download updates - only detect and notify

Use RESEARCH.md code examples as reference, especially "Version Detection and Comparison" section.
  </action>
  <verify>
```bash
cd "C:\Projects\GSDForTabnine\gsd"
# Manual test
node -e "
import('./scripts/version-checker.js').then(async (m) => {
  const current = await m.getCurrentVersion();
  console.log('Current:', current);

  const latest = await m.getLatestVersion();
  console.log('Latest:', latest);

  const check = await m.checkForUpdates();
  console.log('Update check:', check);
});
"
```

Expected: Current version from package.json, latest from npm (or null if network unavailable), update check result.
  </verify>
  <done>version-checker.js exports 3 functions, all return correct data, network errors handled gracefully</done>
</task>

<task type="auto">
  <name>Task 3: Add module to exports and test</name>
  <files>gsd/package.json, gsd/scripts/index.js</files>
  <action>
Add version-checker to package.json exports for external access.

1. Update gsd/package.json exports field:
```json
"exports": {
  ".": "./scripts/index.js",
  "./state-manager": "./scripts/state-manager.js",
  "./template-renderer": "./scripts/template-renderer.js",
  "./guideline-loader": "./scripts/guideline-loader.js",
  "./validator": "./scripts/validator.js",
  "./researcher": "./scripts/researcher.js",
  "./research-synthesizer": "./scripts/research-synthesizer.js",
  "./version-checker": "./scripts/version-checker.js"
}
```

2. Update gsd/scripts/index.js to re-export version-checker functions:
```javascript
// Add to existing exports
export { checkForUpdates, getCurrentVersion, getLatestVersion } from './version-checker.js';
```

3. Verify exports work:
```bash
node -e "import('gsd-for-tabnine/version-checker').then(m => console.log('Export OK'))"
```
  </action>
  <verify>
```bash
cd "C:\Projects\GSDForTabnine\gsd"
# Verify subpath export
node -e "import('./scripts/version-checker.js').then(() => console.log('Direct import OK'))"

# Verify main entry re-export
node -e "import('./scripts/index.js').then((m) => {
  console.log('checkForUpdates:', typeof m.checkForUpdates);
  console.log('getCurrentVersion:', typeof m.getCurrentVersion);
  console.log('getLatestVersion:', typeof m.getLatestVersion);
})"
```

Expected: All three functions exported as "function".
  </verify>
  <done>version-checker subpath export added, main entry re-exports all 3 functions, verification passes</done>
</task>

</tasks>

<verification>
**Module exports:**
- version-checker.js exports checkForUpdates, getCurrentVersion, getLatestVersion
- Functions accessible via subpath import (gsd-for-tabnine/version-checker)
- Functions re-exported from main entry (gsd-for-tabnine)

**Version detection:**
- getCurrentVersion reads local package.json
- getLatestVersion queries npm registry
- Network failures handled gracefully (no crashes)

**Version comparison:**
- checkForUpdates uses semver.gt for comparison
- Returns update type (major/minor/patch) when update available
- Returns hasUpdate: false when current or network unavailable
</verification>

<success_criteria>
**Plan complete when:**
1. semver and update-notifier dependencies installed
2. version-checker.js exists with 3 exported functions
3. getCurrentVersion returns version from package.json
4. getLatestVersion queries npm registry successfully
5. checkForUpdates compares versions using semver
6. Network failures handled gracefully (no crashes)
7. Module exported via package.json and index.js
8. Manual verification shows correct version detection
</success_criteria>

<output>
After completion, create `.planning/phases/11-upgrade-system/11-01-SUMMARY.md`
</output>
