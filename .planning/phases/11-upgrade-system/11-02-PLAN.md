---
phase: 11-upgrade-system
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - gsd/scripts/backup-manager.js
  - gsd/package.json
autonomous: true

must_haves:
  truths:
    - System creates timestamped backups before destructive operations
    - Backups validate successfully before proceeding with upgrade
    - System can restore from backup on upgrade failure
    - Backup directory structure preserves original file organization
    - User can list available backups and manually rollback
  artifacts:
    - path: gsd/scripts/backup-manager.js
      provides: Backup creation and restoration
      exports: [createBackup, restoreBackup, listBackups, validateBackup]
      min_lines: 120
    - path: gsd/package.json
      provides: Updated dependencies
      contains: fs-extra
  key_links:
    - from: gsd/scripts/backup-manager.js
      to: fs-extra
      via: import
      pattern: "import.*fs-extra"
    - from: gsd/scripts/backup-manager.js
      to: .gsd-backups/ directory
      via: file copy
      pattern: "copy.*gsd-backups"
---

<objective>
Implement backup and rollback system to provide safety net for upgrade operations.

Purpose: Protect users from upgrade failures by creating verifiable backups before destructive operations and enabling rollback to known-good state.

Output: Backup manager module with create, restore, list, and validate capabilities.
</objective>

<execution_context>
@C:\Projects\GSDForTabnine\.claude\get-stuff-done\workflows\execute-plan.md
@C:\Projects\GSDForTabnine\.claude\get-stuff-done\templates\summary.md
</execution_context>

<context>
@C:\Projects\GSDForTabnine\.planning\PROJECT.md
@C:\Projects\GSDForTabnine\.planning\ROADMAP.md
@C:\Projects\GSDForTabnine\.planning\STATE.md
@C:\Projects\GSDForTabnine\.planning\phases\11-upgrade-system\11-RESEARCH.md

# Existing infrastructure
@C:\Projects\GSDForTabnine\gsd\package.json
@C:\Projects\GSDForTabnine\gsd\scripts\file-ops.js
@C:\Projects\GSDForTabnine\gsd\scripts\state-manager.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install fs-extra dependency</name>
  <files>gsd/package.json, gsd/package-lock.json</files>
  <action>
Install fs-extra for enhanced file operations with better error handling.

Run from gsd/ directory:
```bash
cd "C:\Projects\GSDForTabnine\gsd"
npm install fs-extra@^11.2.0
```

fs-extra provides:
- Recursive directory copy with error handling
- Atomic move/remove operations
- Promise-based API (async/await friendly)
- Cross-platform compatibility (Windows paths handled correctly)

Already used by many enterprise tools for backup operations (Nx, Angular CLI, Create React App).

Verify installation:
```bash
node -e "import('fs-extra').then(() => console.log('fs-extra OK'))"
```
  </action>
  <verify>
```bash
cd "C:\Projects\GSDForTabnine\gsd"
node -e "import('fs-extra').then(fs => console.log('fs-extra methods:', Object.keys(fs).slice(0, 10)))"
grep "fs-extra" package.json
```
  </verify>
  <done>fs-extra installed, import works, package.json updated</done>
</task>

<task type="auto">
  <name>Task 2: Create backup-manager.js module</name>
  <files>gsd/scripts/backup-manager.js</files>
  <action>
Create gsd/scripts/backup-manager.js with four exported functions for backup management.

Implementation requirements:

**Function 1: createBackup(sourceDir = 'gsd', options = {})**
- Creates timestamped backup directory: `.gsd-backups/backup-${Date.now()}/`
- Copies entire sourceDir using fs-extra.copy() recursively
- Excludes node_modules/ from backup (too large, can reinstall)
- Creates backup metadata file: backup-metadata.json with { timestamp, version, sourceDir, files }
- Returns backup path and metadata object
- Uses try-finally for cleanup on error

**Function 2: validateBackup(backupPath)**
- Checks backup directory exists and is readable
- Verifies backup-metadata.json exists and is valid JSON
- Counts files in backup, compares to metadata.files count
- Checks for critical files: package.json, .gsd-config.json, scripts/, templates/, guidelines/
- Returns { valid: boolean, errors: string[] }
- Does NOT fail if validation fails - returns errors array for caller to decide

**Function 3: restoreBackup(backupPath, targetDir = 'gsd', options = {})**
- Validates backup first using validateBackup()
- Creates temp backup of current state before restore (safety net)
- Removes existing targetDir (except node_modules if preserveNodeModules: true)
- Copies backup contents to targetDir using fs-extra.copy()
- If restore fails, restores from temp backup
- Returns { restored: boolean, backupPath: string, tempBackup: string }

**Function 4: listBackups(backupsDir = '.gsd-backups')**
- Scans backupsDir for backup directories
- Reads metadata from each backup
- Returns array of { path, timestamp, version, filesCount, valid }
- Sorts by timestamp (newest first)
- Handles missing or corrupted metadata gracefully

**Backup directory structure:**
```
.gsd-backups/
├── backup-1737587000000/
│   ├── backup-metadata.json
│   ├── scripts/
│   ├── templates/
│   ├── guidelines/
│   ├── .gsd-config.json
│   └── package.json
└── backup-1737587100000/
    └── ...
```

**DO NOT:**
- Copy node_modules/ (too large, can npm install if needed)
- Auto-delete old backups (user's decision)
- Restore without validation (safety check)

Use RESEARCH.md "Backup and Rollback" pattern as reference.
  </action>
  <verify>
```bash
cd "C:\Projects\GSDForTabnine"
# Manual test
node -e "
import('./gsd/scripts/backup-manager.js').then(async (m) => {
  // Test 1: Create backup
  console.log('Creating backup...');
  const backup = await m.createBackup('gsd');
  console.log('Backup created:', backup.backupPath);

  // Test 2: Validate backup
  console.log('Validating backup...');
  const validation = await m.validateBackup(backup.backupPath);
  console.log('Valid:', validation.valid);
  if (!validation.valid) console.log('Errors:', validation.errors);

  // Test 3: List backups
  console.log('Listing backups...');
  const backups = await m.listBackups();
  console.log('Backups found:', backups.length);

  console.log('✅ All backup operations work');
});
"
```

Expected: Backup created in .gsd-backups/, validation passes, backup listed correctly.
  </verify>
  <done>backup-manager.js exports 4 functions, creates valid backups, validation works, restore logic implemented</done>
</task>

<task type="auto">
  <name>Task 3: Add module to exports and integrate</name>
  <files>gsd/package.json, gsd/scripts/index.js</files>
  <action>
Add backup-manager to package.json exports and main entry.

1. Update gsd/package.json exports field:
```json
"exports": {
  ".": "./scripts/index.js",
  "./state-manager": "./scripts/state-manager.js",
  "./template-renderer": "./scripts/template-renderer.js",
  "./guideline-loader": "./scripts/guideline-loader.js",
  "./validator": "./scripts/validator.js",
  "./researcher": "./scripts/researcher.js",
  "./research-synthesizer": "./scripts/research-synthesizer.js",
  "./version-checker": "./scripts/version-checker.js",
  "./backup-manager": "./scripts/backup-manager.js"
}
```

2. Update gsd/scripts/index.js to re-export backup-manager functions:
```javascript
// Add to existing exports
export { createBackup, restoreBackup, listBackups, validateBackup } from './backup-manager.js';
```

3. Add .gsd-backups/ to .gitignore (backups are local-only):
```bash
echo "" >> .gitignore
echo "# Upgrade backups (local only)" >> .gitignore
echo ".gsd-backups/" >> .gitignore
```
  </action>
  <verify>
```bash
cd "C:\Projects\GSDForTabnine\gsd"
# Verify subpath export
node -e "import('./scripts/backup-manager.js').then(() => console.log('Direct import OK'))"

# Verify main entry re-export
node -e "import('./scripts/index.js').then((m) => {
  console.log('createBackup:', typeof m.createBackup);
  console.log('restoreBackup:', typeof m.restoreBackup);
  console.log('listBackups:', typeof m.listBackups);
  console.log('validateBackup:', typeof m.validateBackup);
})"

# Verify .gitignore
grep ".gsd-backups" .gitignore
```

Expected: All four functions exported as "function", .gitignore contains .gsd-backups/.
  </verify>
  <done>backup-manager subpath export added, main entry re-exports all 4 functions, .gitignore updated</done>
</task>

</tasks>

<verification>
**Module exports:**
- backup-manager.js exports createBackup, restoreBackup, listBackups, validateBackup
- Functions accessible via subpath import (gsd-for-tabnine/backup-manager)
- Functions re-exported from main entry (gsd-for-tabnine)

**Backup creation:**
- Creates timestamped backup directories in .gsd-backups/
- Excludes node_modules/ from backup
- Generates backup-metadata.json with version and file count

**Backup validation:**
- Checks directory structure and metadata validity
- Verifies critical files present
- Returns errors array (doesn't throw)

**Backup restoration:**
- Validates before restore
- Creates safety backup before overwrite
- Rolls back on failure

**Integration:**
- .gsd-backups/ added to .gitignore
- Module exported via package.json
</verification>

<success_criteria>
**Plan complete when:**
1. fs-extra dependency installed
2. backup-manager.js exists with 4 exported functions
3. createBackup creates timestamped backups with metadata
4. validateBackup checks structure and critical files
5. restoreBackup restores from backup with safety net
6. listBackups returns sorted array of available backups
7. .gsd-backups/ added to .gitignore
8. Module exported via package.json and index.js
9. Manual verification shows backup/restore works
</success_criteria>

<output>
After completion, create `.planning/phases/11-upgrade-system/11-02-SUMMARY.md`
</output>
