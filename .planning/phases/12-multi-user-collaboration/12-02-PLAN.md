---
phase: 12-multi-user-collaboration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - gsd/scripts/conflict-checker.js
  - gsd/templates/.pre-commit-config.yaml
  - gsd/package.json
autonomous: true

must_haves:
  truths:
    - "Developers can detect merge conflicts before pushing via conflict-checker.js"
    - "Pre-commit hooks template exists for validating commits"
    - "Conflict detection uses Git's native three-way merge dry-run"
  artifacts:
    - path: "gsd/scripts/conflict-checker.js"
      provides: "Pre-merge conflict detection"
      exports: ["checkForConflicts", "detectPhaseArtifactConflicts"]
      min_lines: 60
    - path: "gsd/templates/.pre-commit-config.yaml"
      provides: "Pre-commit hooks configuration template"
      contains: "conventional-pre-commit"
  key_links:
    - from: "conflict-checker.js"
      to: "git merge --no-commit --no-ff"
      via: "spawn child process for dry-run merge"
      pattern: "spawn.*git.*merge.*--no-commit"
    - from: ".pre-commit-config.yaml"
      to: "conventional-pre-commit"
      via: "pre-commit hook definition"
      pattern: "conventional-pre-commit"
---

<objective>
Implement conflict detection and commit validation infrastructure using Git-native merge dry-run and pre-commit hooks framework.

Purpose: Enable developers to detect conflicts early (before push) and enforce collaboration conventions (Conventional Commits, no merge conflict markers).

Output: conflict-checker.js script for pre-merge validation and .pre-commit-config.yaml template for commit-time checks.
</objective>

<execution_context>
@C:/Projects/GSDForTabnine/.claude/get-stuff-done/workflows/execute-plan.md
@C:/Projects/GSDForTabnine/.claude/get-stuff-done/templates/summary.md
</execution_context>

<context>
@C:/Projects/GSDForTabnine/.planning/PROJECT.md
@C:/Projects/GSDForTabnine/.planning/ROADMAP.md
@C:/Projects/GSDForTabnine/.planning/STATE.md
@C:/Projects/GSDForTabnine/.planning/phases/12-multi-user-collaboration/12-RESEARCH.md

# Relevant prior work
@C:/Projects/GSDForTabnine/gsd/scripts/process-runner.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create conflict detection script</name>
  <files>gsd/scripts/conflict-checker.js, gsd/package.json</files>
  <action>
Create gsd/scripts/conflict-checker.js implementing Git-native conflict detection using merge dry-run pattern.

Research pattern from 12-RESEARCH.md lines 517-530 (Detecting Conflicts Before Merge).

Functions to export (2 total):

1. checkForConflicts(currentBranch, targetBranch = 'main')
   - Purpose: Detect if merging currentBranch into targetBranch would cause conflicts
   - Implementation:
     * Execute: git fetch origin {targetBranch} (ensure latest)
     * Find common ancestor: git merge-base {currentBranch} {targetBranch}
     * Execute: git merge --no-commit --no-ff {targetBranch} (dry-run)
     * Check exit code: 0 = no conflicts, non-zero = conflicts detected
     * Parse stdout/stderr for conflict file paths
     * Execute: git merge --abort (cancel dry-run)
   - Returns: { hasConflicts: boolean, conflictFiles: string[], mergeBase: string }
   - Error handling: wrap in try-catch, ensure merge --abort runs in finally block

2. detectPhaseArtifactConflicts(phaseNumber)
   - Purpose: Check if .planning/phases/{NN}-*/ directory has uncommitted changes that might conflict
   - Implementation:
     * Execute: git diff --name-only .planning/phases/{phaseNumber}-*/
     * Execute: git diff --cached --name-only .planning/phases/{phaseNumber}-*/
     * Combine results to get all modified phase artifacts
     * Check if any files exist in remote branch (git ls-tree)
   - Returns: { modifiedFiles: string[], potentialConflicts: string[] }
   - Use case: warn developer if working on same phase as someone else

Implementation details:
- Use spawn from 'node:child_process' with promisify pattern
- Use ESM syntax: export async function checkForConflicts(...)
- Add executable shebang: #!/usr/bin/env node
- Add CLI support for manual checks: node conflict-checker.js [branch] [target]
- Logging: console.log conflict file paths, merge base commit hash
- Error messages: include git command that failed and remediation steps
- Cross-platform: use path.join for phase directory construction

Package.json updates:
- Add subpath export: "./conflict-checker": "./scripts/conflict-checker.js"
- Add to main index.js exports: checkForConflicts, detectPhaseArtifactConflicts

Why this approach: Git's merge dry-run (--no-commit --no-ff) uses same three-way merge algorithm as real merge, providing accurate conflict detection. Research recommends this over custom file diff scanning (lines 312-325).

Do NOT implement file locking or custom lock files - Git's object model handles concurrent writes safely (research lines 320-323).
  </action>
  <verify>
node gsd/scripts/conflict-checker.js feature-branch main works (detects conflicts)
ESLint passes (no syntax errors)
Git merge --abort executes even if error occurs (finally block verification)
CLI outputs conflict file paths when conflicts detected
  </verify>
  <done>
conflict-checker.js exists with 2 exported functions (checkForConflicts, detectPhaseArtifactConflicts)
CLI execution checks for conflicts between branches
Dry-run merge uses --no-commit --no-ff flags (research recommendation)
merge --abort always executes in finally block (prevents corrupted state)
package.json includes conflict-checker subpath export
  </done>
</task>

<task type="auto">
  <name>Task 2: Create pre-commit hooks configuration template</name>
  <files>gsd/templates/.pre-commit-config.yaml</files>
  <action>
Create gsd/templates/.pre-commit-config.yaml implementing pre-commit hooks for commit validation.

Research pattern from 12-RESEARCH.md lines 160-188 and 582-612 (Pre-Commit Hook Configuration).

Template structure (YAML format):
```yaml
# Pre-commit hooks configuration for GSD collaboration
# Installation: npm install -g pre-commit && pre-commit install
# Documentation: https://pre-commit.com/

repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      # Detect merge conflict markers in files
      - id: check-merge-conflict

      # Prevent commits directly to protected branches
      - id: no-commit-to-branch
        args: ['--branch', 'main', '--branch', 'master']

      # Check for file name conflicts on case-insensitive filesystems
      - id: check-case-conflict

      # Validate YAML/JSON structure
      - id: check-yaml
        files: \.(yml|yaml)$
      - id: check-json
        files: \.(json|jsonc)$

      # Trailing whitespace and end-of-file fixer
      - id: trailing-whitespace
      - id: end-of-file-fixer

  # Enforce Conventional Commits format
  - repo: https://github.com/compilerla/conventional-pre-commit
    rev: v3.0.0
    hooks:
      - id: conventional-pre-commit
        stages: [commit-msg]
```

Implementation notes:
- This is a template file, not a working pre-commit config (users copy to project root and customize)
- Comments explain installation steps (npm install -g pre-commit && pre-commit install)
- Comments explain purpose of each hook
- YAML structure validated before committing
- Protected branches list customizable (main, master by default)

Hook explanations to include in comments:
1. check-merge-conflict: Catches accidentally committed conflict markers (<<<<<<< =======)
2. no-commit-to-branch: Enforces PR workflow (prevents direct commits to main)
3. check-case-conflict: Prevents issues on case-insensitive filesystems (Windows, macOS)
4. check-yaml/json: Validates artifact structure before commit
5. conventional-pre-commit: Enforces commit message format (feat:, fix:, docs:, etc.)

Why this approach: pre-commit framework is de facto standard for Git hook automation, widely adopted, language-agnostic. Research confirms this is state-of-the-art (lines 687-693).

Users install separately: This template demonstrates recommended setup but requires manual installation (pre-commit is Python-based, not npm).
  </action>
  <verify>
gsd/templates/.pre-commit-config.yaml exists
YAML syntax is valid (npx js-yaml gsd/templates/.pre-commit-config.yaml)
File contains conventional-pre-commit hook configuration
Comments explain installation and usage
  </verify>
  <done>
.pre-commit-config.yaml template exists in gsd/templates/
Template includes 5+ pre-commit hooks (merge conflict, branch protection, case conflict, YAML/JSON validation, Conventional Commits)
Comments explain purpose of each hook
Comments include installation instructions
YAML structure is valid
  </done>
</task>

</tasks>

<verification>
1. conflict-checker.js detects merge conflicts using git merge dry-run
2. conflict-checker.js always aborts dry-run merge (finally block)
3. detectPhaseArtifactConflicts warns about simultaneous phase work
4. .pre-commit-config.yaml template is valid YAML
5. Template includes Conventional Commits enforcement hook
6. Package exports include conflict-checker module
</verification>

<success_criteria>
- Developers can check for conflicts before pushing (checkForConflicts function)
- Phase artifact conflicts detected (detectPhaseArtifactConflicts warns about same-phase work)
- Pre-commit template ready for project installation
- Conventional Commits format enforced via template
- All validation uses Git-native commands (no custom file scanning)
</success_criteria>

<output>
After completion, create `.planning/phases/12-multi-user-collaboration/12-02-SUMMARY.md`
</output>
