---
phase: 12-multi-user-collaboration
plan: 03
type: execute
wave: 2
depends_on: ["12-01", "12-02"]
files_modified:
  - gsd/guidelines/COLLABORATION.md
  - gsd/scripts/integration-test.js
  - gsd/README.md
autonomous: true

must_haves:
  truths:
    - "Developers can read COLLABORATION.md to understand multi-user workflow"
    - "Branch-per-story pattern documented with examples (feature/bugfix/hotfix)"
    - "Phase-to-story mapping guidance documented (1:1, decimal sub-phases)"
    - "Bitbucket-specific guidance documented (branch permissions, merge checks, Pipelines)"
    - "Merge strategies and conflict resolution documented"
    - "Integration tests validate worktree and conflict detection functionality"
  artifacts:
    - path: "gsd/guidelines/COLLABORATION.md"
      provides: "Complete multi-user collaboration guide"
      contains: "Git worktree"
      min_lines: 200
    - path: "gsd/scripts/integration-test.js"
      provides: "Test Suite 18 for Phase 12 modules"
      contains: "Test Suite 18"
  key_links:
    - from: "COLLABORATION.md"
      to: "setup-worktree.js"
      via: "script usage documentation"
      pattern: "setup-worktree"
    - from: "COLLABORATION.md"
      to: "conflict-checker.js"
      via: "conflict detection workflow"
      pattern: "conflict-checker"
---

<objective>
Document multi-user collaboration workflows and validate Phase 12 functionality through comprehensive testing.

Purpose: Provide developers with clear collaboration guidelines (workflow, patterns, merge strategies) and ensure all collaboration infrastructure works correctly via integration tests.

Output: COLLABORATION.md guideline, Test Suite 18 (8 tests), updated README.md with collaboration section.
</objective>

<execution_context>
@C:/Projects/GSDForTabnine/.claude/get-stuff-done/workflows/execute-plan.md
@C:/Projects/GSDForTabnine/.claude/get-stuff-done/templates/summary.md
</execution_context>

<context>
@C:/Projects/GSDForTabnine/.planning/PROJECT.md
@C:/Projects/GSDForTabnine/.planning/ROADMAP.md
@C:/Projects/GSDForTabnine/.planning/STATE.md
@C:/Projects/GSDForTabnine/.planning/phases/12-multi-user-collaboration/12-RESEARCH.md

# Prior plans in this phase
@C:/Projects/GSDForTabnine/.planning/phases/12-multi-user-collaboration/12-01-PLAN.md
@C:/Projects/GSDForTabnine/.planning/phases/12-multi-user-collaboration/12-02-PLAN.md

# Integration test pattern
@C:/Projects/GSDForTabnine/gsd/scripts/integration-test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create collaboration guideline</name>
  <files>gsd/guidelines/COLLABORATION.md, gsd/README.md</files>
  <action>
Create gsd/guidelines/COLLABORATION.md documenting multi-user collaboration workflows, patterns, and best practices.

Research-based content from 12-RESEARCH.md (patterns section lines 64-488).

Document structure (9 sections minimum):

1. Overview
   - Purpose: Git-based distributed collaboration without central server
   - Key patterns: branch-per-story, worktree isolation, three-way merge
   - Benefits: offline-capable, no single point of failure, automatic conflict detection
   - Works with: GitHub, Bitbucket, GitLab (Git-native patterns)

2. When to Use GSD Phases
   - Use GSD phases for:
     * ✓ New features (planned capabilities)
     * ✓ Major refactoring (planned technical changes)
     * ✓ Architecture evolution (planned system changes)
   - Do NOT use GSD phases for:
     * ✗ Bugfixes (fix existing code directly)
     * ✗ Hotfixes (emergency production patches)
     * ✗ Small maintenance (dependency updates, typo fixes)
   - Rationale: GSD adds structure for planning and executing NEW work. Bugfixes and hotfixes work with existing code, don't need new phases.

3. Branch Patterns
   - Pattern 1: Feature Stories (use GSD phases)
     ```bash
     # Story implements Phase 5
     node gsd/scripts/setup-worktree.js story/ABC-123 5
     cd ../worktrees/story-abc123-phase-5
     # Follow phase plans, commit, push
     ```
   - Pattern 2: Bugfix Stories (plain Git worktree, no phase)
     ```bash
     # Fix bug in existing code
     git worktree add ../bugfix-abc124 -b bugfix/ABC-124
     cd ../bugfix-abc124
     # Fix bug, commit, push - no .planning/ updates
     ```
   - Pattern 3: Hotfix Issues (from production branch)
     ```bash
     # Emergency production fix
     git worktree add ../hotfix-critical -b hotfix/CRITICAL production
     cd ../hotfix-critical
     # Fix, test, deploy, cherry-pick to main
     ```
   - Phase-to-Story Mapping:
     * One story per phase: story/ABC-123 → Phase 5
     * Multiple stories per phase: Use decimal sub-phases (story/ABC-123 → Phase 5.1, story/ABC-124 → Phase 5.2)
     * Avoid: Two stories working in same phase directory (causes merge conflicts)

4. Getting Started (Quick Start)
   - Prerequisites: Git 2.33.0+ (for ort merge strategy)
   - Installation: Copy .pre-commit-config.yaml to project root, install pre-commit framework
   - First worktree (feature story): node gsd/scripts/setup-worktree.js story/ABC-123 5
   - Next steps: cd to worktree, work on phase, commit, push, create PR

5. Branch-Per-Story Workflow
   - Pattern: Each story works in its own branch checked out in separate worktree
   - Branch naming: story/{TICKET-ID} (e.g., story/ABC-123, story/XYZ-456)
   - Workspace isolation: Each worktree has independent .planning/STATE.md
   - Example commands:
     ```bash
     # Story ABC-123 starts Phase 5
     node gsd/scripts/setup-worktree.js story/ABC-123 5
     cd ../worktrees/story-abc123-phase-5
     # Work, commit, push
     git push -u origin story/ABC-123
     ```

6. Conflict Detection and Resolution
   - Pre-merge check: node gsd/scripts/conflict-checker.js story/ABC-123 main
   - Interpreting results: hasConflicts true/false, conflictFiles array
   - Resolution strategies:
     * Merge with ours: git merge -X ours story/ABC-123
     * Merge with theirs: git merge -X theirs story/ABC-123
     * Manual resolution: edit files, git add, git commit
   - Phase artifact conflicts: detectPhaseArtifactConflicts warns about same-phase work

7. Merge Strategies
   - Three-way merge: Git's default ort strategy (automatic conflict detection)
   - Pull request workflow: Create PR, status checks pass, merge to main
   - Co-authored commits: Use Co-authored-by trailers for attribution
   - Conventional Commits: Format: <type>(<scope>): <description>
   - Example:
     ```bash
     git commit -m "feat(phase-05): add distribution metadata

     Co-authored-by: Alice Smith <alice@example.com>"
     ```

8. Bitbucket-Specific Guidance
   - Branch permissions: Configure in Repository settings > Branch permissions
     * Restrict who can merge to main/develop
     * Require approvals before merge
     * Enforce merge checks (build passing, no conflicts)
   - Pull request workflow:
     * Create PR from story branch to main
     * Request reviewers
     * Run Bitbucket Pipelines build
     * Merge when approved + build passes
   - Bitbucket Pipelines integration:
     * Run npm test in CI
     * Block merge if tests fail
     * Validate Conventional Commits format
   - Research citation: Git Workflow | Atlassian Git Tutorial (Bitbucket's owner)

9. Best Practices and Anti-Patterns
   - DO: Use worktrees for workspace isolation
   - DO: Commit phase artifacts (PLAN.md, code changes)
   - DO: Run conflict-checker before pushing
   - DO: Use Conventional Commits format
   - DO: Use decimal sub-phases when multiple stories work in same phase
   - DON'T: Commit STATE.md (it's gitignored, local working state)
   - DON'T: Force-push shared branches (use --force-with-lease on personal branches only)
   - DON'T: Work on same phase directory simultaneously (coordinate phase assignments)
   - DON'T: Edit files outside your worktree directory
   - DON'T: Use GSD phases for bugfixes or hotfixes (use plain Git workflow)

Include research citations:
- Git worktree docs: https://git-scm.com/docs/git-worktree
- Conventional Commits: https://www.conventionalcommits.org/
- pre-commit framework: https://pre-commit.com/

Update gsd/README.md:
- Add "Multi-User Collaboration" section after "Usage" section
- Briefly describe branch-per-developer workflow
- Link to COLLABORATION.md for full guide
- Mention setup-worktree.js and conflict-checker.js scripts

Why this structure: Provides progressive depth (quick start → detailed patterns → best practices). Based on research section "Architecture Patterns" which covers all essential collaboration concepts.
  </action>
  <verify>
gsd/guidelines/COLLABORATION.md exists
Document contains 9 sections (Overview, When to Use GSD Phases, Branch Patterns, Getting Started, Branch-Per-Story, Conflict Detection, Merge Strategies, Bitbucket-Specific, Best Practices)
Document includes feature/bugfix/hotfix examples
Document includes phase-to-story mapping guidance
Document includes Bitbucket-specific guidance
README.md includes Multi-User Collaboration section
Markdown is valid (no broken links or syntax errors)
  </verify>
  <done>
COLLABORATION.md exists with comprehensive collaboration guide (200+ lines)
Document covers branch-per-story workflow with examples (feature/bugfix/hotfix)
Phase-to-story mapping documented (1:1, decimal sub-phases for parallel stories)
Bitbucket-specific guidance included (branch permissions, merge checks, Pipelines)
Conflict detection and resolution strategies documented
Merge strategies (three-way merge, Co-authored commits, Conventional Commits) explained
Best practices and anti-patterns listed (including "don't use GSD for bugfixes")
README.md updated with collaboration section linking to COLLABORATION.md
  </done>
</task>

<task type="auto">
  <name>Task 2: Add integration tests for Phase 12</name>
  <files>gsd/scripts/integration-test.js</files>
  <action>
Create Test Suite 18 in gsd/scripts/integration-test.js validating Phase 12 collaboration infrastructure.

Follow existing test suite pattern from integration-test.js (Test Suites 1-17).

Test Suite 18: Multi-User Collaboration (8 tests minimum)

1. setup-worktree.js module exports
   - Test: import { setupWorktree, listWorktrees, cleanupWorktree } from './setup-worktree.js'
   - Verify: all 3 functions exist and are typeof function
   - Pass: setupWorktree, listWorktrees, cleanupWorktree all defined

2. conflict-checker.js module exports
   - Test: import { checkForConflicts, detectPhaseArtifactConflicts } from './conflict-checker.js'
   - Verify: both functions exist and are typeof function
   - Pass: checkForConflicts, detectPhaseArtifactConflicts both defined

3. .gitignore excludes STATE.md
   - Test: read .gitignore file, check for STATE.md pattern
   - Verify: file contains "STATE.md" string
   - Pass: .gitignore includes STATE.md exclusion

4. .pre-commit-config.yaml template exists
   - Test: check file exists at gsd/templates/.pre-commit-config.yaml
   - Verify: file is readable, contains "conventional-pre-commit"
   - Pass: template exists with Conventional Commits hook

5. COLLABORATION.md guideline exists
   - Test: check file exists at gsd/guidelines/COLLABORATION.md
   - Verify: file contains "branch-per-developer" and "Git worktree"
   - Pass: guideline exists with collaboration patterns

6. listWorktrees basic functionality
   - Test: call listWorktrees() (may return empty array in test environment)
   - Verify: returns array (even if empty)
   - Pass: function executes without error, returns array

7. detectPhaseArtifactConflicts parameter validation
   - Test: call detectPhaseArtifactConflicts(5) with valid phase number
   - Verify: returns object with modifiedFiles and potentialConflicts properties
   - Pass: function executes, returns expected structure

8. Package exports include collaboration modules
   - Test: check package.json exports field
   - Verify: includes "./setup-worktree" and "./conflict-checker"
   - Pass: both subpath exports defined

Test implementation notes:
- Use try-catch for all tests (accumulate failures, don't stop on first error)
- Import collaboration modules at top of test suite
- Use fs.existsSync for file existence checks
- Use fs.readFileSync for content validation
- Don't create actual worktrees (test environment limitation)
- Mark as warnings if Git commands fail (may not be in Git repo during test)

Update test suite header:
- Change "Test Suites 1-17 (Phases 1-11)" to "Test Suites 1-18 (Phases 1-12)"
- Increment total test count by 8
- Add Phase 12 to suite list

Why 8 tests: Covers all new modules (2), configuration files (3), documentation (1), integration checks (2). Follows existing test suite pattern of 6-9 tests per suite.
  </action>
  <verify>
npm test runs successfully (all existing tests still pass)
Test Suite 18 appears in output
8 new tests for Phase 12 infrastructure
Total test count increases from 110 to 118
  </verify>
  <done>
Test Suite 18 added to integration-test.js (8 tests for Phase 12)
Tests validate setup-worktree.js exports (3 functions)
Tests validate conflict-checker.js exports (2 functions)
Tests validate .gitignore STATE.md exclusion
Tests validate .pre-commit-config.yaml template
Tests validate COLLABORATION.md guideline
Tests validate package.json collaboration exports
All 118 tests pass (110 existing + 8 new)
  </done>
</task>

</tasks>

<verification>
1. COLLABORATION.md guideline exists with 9 sections
2. Documentation includes "When to Use GSD Phases" guidance (feature vs bugfix vs hotfix)
3. Documentation includes "Branch Patterns" with three scenarios (feature/bugfix/hotfix examples)
4. Documentation includes phase-to-story mapping guidance (1:1, decimal sub-phases)
5. Documentation includes Bitbucket-specific guidance (branch permissions, merge checks, Pipelines)
6. README.md includes Multi-User Collaboration section
7. Test Suite 18 validates all Phase 12 modules
8. npm test passes with 118 total tests (110 existing + 8 new)
</verification>

<success_criteria>
- Comprehensive collaboration guide available to developers (COLLABORATION.md with 200+ lines)
- Branch-per-story workflow documented with examples (feature/bugfix/hotfix)
- Phase-to-story mapping guidance prevents merge conflicts (decimal sub-phases)
- Bitbucket-specific guidance for real-world enterprise use
- Conflict detection and merge strategies explained
- Integration tests validate Phase 12 infrastructure (8 new tests)
- README.md includes collaboration section for discoverability
- All 118 tests pass (Phase 12 doesn't break existing functionality)
</success_criteria>

<output>
After completion, create `.planning/phases/12-multi-user-collaboration/12-03-SUMMARY.md`
</output>
